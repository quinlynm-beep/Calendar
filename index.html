<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>‚ú¶ Aesthetic Calendar</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Caveat:wght@400;600&family=Space+Mono:wght@400;700&family=DM+Serif+Display:ital@0;1&family=Josefin+Sans:wght@100;300;400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Sacramento&family=Nunito:wght@300;400;600&family=Raleway:wght@100;300;400;600&family=Spectral:ital,wght@0,400;0,600;1,400&family=Abril+Fatface&family=UnifrakturMaguntia&family=Cinzel:wght@400;700&family=Bodoni+Moda:ital,wght@0,400;0,700;1,400&family=GFS+Didot:ital@0;1&family=Crimson+Pro:ital,wght@0,400;1,400&family=Barlow+Condensed:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --accent:#4a8fa8;--bg:#eaf4fb;--text:#1a3d52;--card:rgba(255,255,255,.78);
  --font-display:'DM Serif Display',serif;--font-body:'Josefin Sans',sans-serif;--font-accent:'Caveat',cursive;
  --radius:18px;--shadow:0 8px 32px rgba(0,0,0,.12);
  --clock-bg:#c8e6f5;--clock-tc:#1a3d52;--clock-sub:#4a8fa8;
  --theme-grain:0;--theme-noise:none;--theme-texture:none;
  --btn-border-radius:50px;--panel-radius:22px;
}
body{font-family:var(--font-body);background:var(--bg);color:var(--text);min-height:100vh;overflow:hidden;cursor:none;-webkit-user-select:none;user-select:none}
/* CURSOR */
#cursor{position:fixed;width:22px;height:22px;border:2px solid var(--accent);border-radius:50%;pointer-events:none;z-index:9999;transform:translate(-50%,-50%);transition:width .25s,height .25s,background .3s,border-color .3s}
#cursor-dot{position:fixed;width:6px;height:6px;background:var(--accent);border-radius:50%;pointer-events:none;z-index:9999;transform:translate(-50%,-50%);transition:background .3s}
#cursor.big{width:44px;height:44px;background:rgba(74,143,168,.1)}
/* GRAIN OVERLAY */
#grain-overlay{position:fixed;inset:0;z-index:2;pointer-events:none;opacity:var(--theme-grain);background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='.4'/%3E%3C/svg%3E");background-size:200px}
/* SCREENS */
.screen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .8s ease,transform .8s ease}
.screen.hidden{opacity:0;pointer-events:none;transform:scale(.97)}
.screen.visible{opacity:1;pointer-events:all;transform:scale(1)}
.theme-bg{position:fixed;inset:0;z-index:-1;transition:all 1s}
.theme-bg-overlay{position:fixed;inset:0;z-index:0;pointer-events:none}
canvas#particle-canvas{position:fixed;inset:0;pointer-events:none;z-index:1;opacity:.28}

/* ‚ïê‚ïê‚ïê CLOCK ‚ïê‚ïê‚ïê */
#clock-screen{z-index:2;background:transparent}
.clock-inner{position:relative;z-index:3;text-align:center;display:flex;flex-direction:column;align-items:center;padding:16px;width:100%;max-width:580px}
.clock-glass{backdrop-filter:blur(22px);-webkit-backdrop-filter:blur(22px);border:1px solid rgba(255,255,255,.2);border-radius:28px;padding:32px 48px 24px;box-shadow:0 22px 64px rgba(0,0,0,.2);transition:background .9s,border-color .9s;width:100%}
.clock-time{font-family:var(--font-display);font-size:clamp(4.5rem,15vw,10rem);font-weight:300;line-height:.88;color:var(--clock-tc);letter-spacing:-.02em;animation:tP 2.5s ease-in-out infinite;transition:color .9s}
@keyframes tP{0%,100%{opacity:1}50%{opacity:.84}}
.clock-date{font-family:var(--font-accent);font-size:clamp(1rem,2.5vw,1.6rem);color:var(--clock-sub);margin-top:.5rem}
.clock-theme-tag{font-family:var(--font-accent);font-size:1rem;color:var(--clock-sub);opacity:.65;margin-top:.2rem}
.clock-mood-strip{display:flex;align-items:center;justify-content:center;gap:10px;margin-top:.9rem}
.clock-mood-display{font-size:1.6rem;cursor:pointer;transition:transform .2s;filter:drop-shadow(0 2px 6px rgba(0,0,0,.22))}
.clock-mood-display:hover{transform:scale(1.2)}
.clock-mood-label{font-family:var(--font-accent);font-size:.95rem;color:var(--clock-sub);opacity:.65}
.clock-hint{font-family:var(--font-body);font-size:.58rem;letter-spacing:.22em;text-transform:uppercase;color:var(--clock-sub);opacity:.36;margin-top:1.2rem;animation:hP 3.5s ease-in-out infinite}
@keyframes hP{0%,100%{opacity:.36}50%{opacity:.1}}
/* idle events */
.idle-events-wrap{width:100%;margin-top:1.3rem;max-height:36vh;overflow-y:auto}
.idle-events-wrap::-webkit-scrollbar{width:3px}
.idle-events-wrap::-webkit-scrollbar-thumb{background:var(--accent);border-radius:6px}
.idle-events-title{font-family:var(--font-body);font-size:.56rem;letter-spacing:.24em;text-transform:uppercase;color:var(--clock-sub);opacity:.55;text-align:center;margin-bottom:.65rem}
.idle-ev-list{display:flex;flex-direction:column;gap:4px}
.idle-ev-item{display:flex;align-items:center;gap:9px;padding:8px 13px;border-radius:11px;border:1px solid rgba(255,255,255,.14);backdrop-filter:blur(6px)}
.idle-ev-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.idle-ev-text{flex:1;min-width:0}
.idle-ev-name{font-family:var(--font-body);font-size:.76rem;color:var(--clock-tc);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.idle-ev-time{font-family:var(--font-accent);font-size:.66rem;color:var(--clock-sub);opacity:.7}
.idle-ev-cal{font-size:.54rem;font-family:var(--font-body);letter-spacing:.06em;text-transform:uppercase;padding:2px 7px;border-radius:20px;flex-shrink:0;opacity:.75}
.idle-no-events{font-family:var(--font-accent);font-size:.9rem;color:var(--clock-sub);opacity:.3;text-align:center;padding:5px 0}

/* ‚ïê‚ïê‚ïê CALENDAR SCREEN ‚ïê‚ïê‚ïê */
#calendar-screen{justify-content:flex-start;overflow-y:auto;overflow-x:hidden;padding:12px 14px 60px;z-index:2;background:transparent}
#calendar-screen::-webkit-scrollbar{width:4px}
#calendar-screen::-webkit-scrollbar-thumb{background:var(--accent);border-radius:8px}
.cal-header{width:100%;max-width:1060px;display:flex;align-items:center;justify-content:space-between;padding:8px 0 8px;flex-wrap:wrap;gap:7px;position:sticky;top:0;z-index:10}
.cal-header-glass{position:absolute;inset:0;background:rgba(255,255,255,.12);backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);border-radius:14px;border:1px solid rgba(255,255,255,.18);z-index:-1}
.cal-month-name{font-family:var(--font-display);font-size:clamp(1.7rem,4.8vw,2.9rem);font-weight:400;font-style:italic;color:var(--text);line-height:1}
.cal-year{font-family:var(--font-body);font-size:.66rem;letter-spacing:.28em;text-transform:uppercase;color:var(--accent);margin-top:2px}
.cal-nav{display:flex;gap:6px;align-items:center}
.nav-btn{width:38px;height:38px;border:1.5px solid var(--accent);background:rgba(255,255,255,.15);backdrop-filter:blur(8px);border-radius:50%;color:var(--text);font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .25s}
.nav-btn:hover{background:var(--accent);color:#fff;transform:scale(1.1)}
.cal-actions{display:flex;gap:5px;flex-wrap:wrap;align-items:center;padding:0 8px}
.action-btn{padding:6px 13px;border:1.5px solid var(--accent);background:rgba(255,255,255,.15);backdrop-filter:blur(8px);border-radius:var(--btn-border-radius,50px);color:var(--text);font-family:var(--font-body);font-size:.63rem;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:all .25s;white-space:nowrap}
.action-btn:hover,.action-btn.active-btn{background:var(--accent);color:#fff;transform:translateY(-2px)}
.time-toggle{padding:5px 11px;border:1.5px solid var(--accent);background:rgba(255,255,255,.15);border-radius:var(--btn-border-radius,50px);color:var(--text);font-family:var(--font-body);font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:all .25s}
.time-toggle:hover{background:var(--accent);color:#fff}
.month-banner{font-family:var(--font-accent);font-size:clamp(.78rem,1.9vw,1.05rem);color:var(--accent);opacity:.5;text-align:center;margin-bottom:7px;width:100%;max-width:1060px}

/* ‚îÄ‚îÄ CALENDAR SECTIONS ‚îÄ‚îÄ */
.cal-sections-wrap{width:100%;max-width:1060px;display:flex;gap:0;margin-bottom:9px;border-radius:13px;overflow:hidden;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);backdrop-filter:blur(12px)}
.cal-section{flex:1;padding:7px 11px}
.cal-section:not(:last-child){border-right:1px solid rgba(255,255,255,.15)}
.cal-section-label{font-family:var(--font-body);font-size:.56rem;letter-spacing:.16em;text-transform:uppercase;color:var(--accent);margin-bottom:4px;opacity:.7}
.cal-section-tabs{display:flex;flex-wrap:wrap;gap:3px}
.section-tab{padding:3px 9px;border-radius:20px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.07);color:var(--text);font-family:var(--font-body);font-size:.57rem;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:3px}
.section-tab:hover,.section-tab.active{border-color:var(--accent);background:var(--accent);color:#fff}
.section-tab-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.add-cal-inline{padding:3px 9px;border-radius:20px;border:1px dashed var(--accent);background:transparent;color:var(--accent);font-family:var(--font-body);font-size:.57rem;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;transition:all .2s;opacity:.6}
.add-cal-inline:hover{opacity:1;background:var(--accent);color:#fff;border-style:solid}

/* ‚îÄ‚îÄ CALENDAR GRID ‚îÄ‚îÄ */
.cal-grid-wrap{width:100%;max-width:1060px;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.1);backdrop-filter:blur(14px)}
.cal-weekdays{display:grid;grid-template-columns:repeat(7,1fr);background:var(--accent)}
.cal-weekday{text-align:center;padding:9px 4px;font-family:var(--font-body);font-size:.58rem;letter-spacing:.14em;text-transform:uppercase;color:#fff}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr)}
.cal-day{min-height:92px;padding:5px 5px 3px;border-right:1px solid rgba(255,255,255,.1);border-bottom:1px solid rgba(255,255,255,.1);cursor:pointer;transition:background .2s;position:relative;overflow:hidden;display:flex;flex-direction:column}
.cal-day:hover{background:rgba(255,255,255,.14)}
.cal-day.today .d-num{background:var(--accent);color:#fff;border-radius:50%}
.cal-day.other-month{opacity:.25}
.cal-day.has-photo::after{content:'üì∑';position:absolute;bottom:3px;right:4px;font-size:.7rem;opacity:.6}
.d-num{font-family:var(--font-display);font-size:.95rem;color:var(--text);width:24px;height:24px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.d-dots{display:flex;flex-wrap:wrap;gap:2px;padding:2px 1px 0;min-height:10px}
.d-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.d-mood{position:absolute;top:4px;right:5px;font-size:.78rem;line-height:1;opacity:.82}
.d-holiday-badge{position:absolute;top:3px;right:5px;font-size:.68rem;opacity:.65}
.d-has-mood .d-holiday-badge{right:22px}
.d-labels{display:flex;flex-direction:column;gap:1px;margin-top:2px;flex:1;overflow:hidden}
.ev-chip{font-size:.56rem;padding:2px 5px;border-radius:4px;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;font-family:var(--font-body);display:flex;align-items:center;gap:2px;line-height:1.3}
.ev-chip.holiday-chip{background:rgba(200,160,0,.72)!important;font-style:italic}
.ev-chip.combined-tag{border-left:3px solid rgba(255,255,255,.5)}
.ev-more{font-size:.52rem;color:var(--accent);opacity:.65;font-family:var(--font-body);padding:0 3px}

/* ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ */
.tooltip{position:fixed;background:rgba(255,255,255,.96);backdrop-filter:blur(18px);border:1.5px solid var(--accent);border-radius:13px;padding:12px 14px;box-shadow:0 14px 40px rgba(0,0,0,.2);z-index:600;min-width:175px;max-width:250px;pointer-events:none;opacity:0;transform:translateY(6px);transition:opacity .2s,transform .2s;font-family:var(--font-body)}
.tooltip.show{opacity:1;transform:translateY(0)}
.tt-date{font-family:var(--font-accent);font-size:1rem;color:var(--accent);margin-bottom:6px}
.tt-ev{font-size:.71rem;padding:3px 0 3px 8px;border-left:3px solid;margin-bottom:3px;color:#333;line-height:1.4;display:flex;align-items:flex-start;justify-content:space-between;gap:4px}
.tt-ev-main{flex:1}
.tt-del{background:none;border:none;cursor:pointer;color:#ddd;font-size:.75rem;line-height:1;transition:color .2s;flex-shrink:0;padding:0 2px;pointer-events:all}
.tt-del:hover{color:#e05050}
.tt-holiday-row{background:rgba(255,215,0,.12);border-left:3px solid #e8b000;padding:3px 8px;border-radius:4px;margin-bottom:3px;font-size:.7rem;font-style:italic;color:#6a4a00}
.tt-cal-tag{font-size:.57rem;opacity:.5;letter-spacing:.07em;text-transform:uppercase;margin-top:2px}
.tt-empty{font-size:.68rem;color:#aaa;font-style:italic}
.tt-mood{font-size:.72rem;margin-bottom:5px;padding:3px 8px;background:rgba(128,128,128,.07);border-radius:6px;display:flex;align-items:center;gap:5px}

/* ‚îÄ‚îÄ DAY DETAIL PANEL ‚îÄ‚îÄ */
#day-panel{position:fixed;background:rgba(255,255,255,.97);border-radius:var(--panel-radius);box-shadow:0 24px 70px rgba(0,0,0,.22);z-index:800;padding:0;transition:opacity .35s cubic-bezier(.34,1.56,.64,1),transform .35s cubic-bezier(.34,1.56,.64,1);opacity:0;pointer-events:none;border:1.5px solid rgba(128,128,128,.1);width:min(480px,96vw);top:50%;left:50%;transform:translate(-50%,-50%) scale(.92);max-height:94vh;overflow:hidden;display:flex;flex-direction:column}
#day-panel.show{opacity:1;pointer-events:all;transform:translate(-50%,-50%) scale(1)}
.dp-photo-header{width:100%;height:140px;background:linear-gradient(135deg,rgba(74,143,168,.3),rgba(74,143,168,.1));position:relative;flex-shrink:0;overflow:hidden;border-radius:var(--panel-radius) var(--panel-radius) 0 0}
.dp-photo-img{width:100%;height:100%;object-fit:cover;display:none}
.dp-photo-img.loaded{display:block}
.dp-photo-placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;cursor:pointer;transition:background .2s}
.dp-photo-placeholder:hover{background:rgba(255,255,255,.1)}
.dp-photo-placeholder span{font-size:1.8rem}
.dp-photo-placeholder p{font-family:var(--font-body);font-size:.62rem;letter-spacing:.12em;text-transform:uppercase;color:var(--accent);opacity:.65}
.dp-photo-change{position:absolute;bottom:8px;right:10px;background:rgba(0,0,0,.45);color:#fff;border:none;border-radius:20px;padding:4px 10px;font-family:var(--font-body);font-size:.58rem;cursor:pointer;letter-spacing:.08em;text-transform:uppercase}
#dp-photo-input{display:none}
.dp-body{padding:18px 20px 20px;overflow-y:auto;flex:1}
.dp-body::-webkit-scrollbar{width:3px}
.dp-body::-webkit-scrollbar-thumb{background:var(--accent);border-radius:6px}
.dp-date-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.dp-date-title{font-family:var(--font-display);font-size:1.5rem;font-style:italic;color:var(--text)}
.dp-close{background:none;border:none;font-size:1.3rem;cursor:pointer;color:#bbb;transition:color .2s,transform .2s}
.dp-close:hover{color:var(--accent);transform:rotate(90deg)}
.dp-mood-row{display:flex;align-items:center;gap:8px;margin-bottom:14px;padding:10px 12px;background:rgba(128,128,128,.05);border-radius:11px;border:1px solid rgba(128,128,128,.1)}
.dp-mood-label{font-family:var(--font-body);font-size:.6rem;letter-spacing:.14em;text-transform:uppercase;color:var(--accent);flex-shrink:0}
.dp-mood-emojis{display:flex;gap:6px;flex:1;flex-wrap:wrap}
.mood-btn{font-size:1.4rem;background:none;border:2px solid transparent;border-radius:8px;padding:3px 5px;cursor:pointer;transition:all .2s;line-height:1}
.mood-btn:hover{transform:scale(1.2)}
.mood-btn.sel{border-color:var(--accent);background:rgba(74,143,168,.1);transform:scale(1.15)}
.dp-mood-clear{font-family:var(--font-body);font-size:.58rem;color:#aaa;cursor:pointer;transition:color .2s;background:none;border:none;letter-spacing:.08em;text-transform:uppercase}
.dp-mood-clear:hover{color:#e05050}
.dp-section-title{font-family:var(--font-body);font-size:.58rem;letter-spacing:.18em;text-transform:uppercase;color:var(--accent);margin-bottom:8px;opacity:.75;display:flex;align-items:center;justify-content:space-between}
.dp-ev-list{display:flex;flex-direction:column;gap:5px;margin-bottom:14px}
.dp-ev-item{display:flex;align-items:center;gap:8px;padding:8px 11px;border-radius:10px;border:1px solid rgba(128,128,128,.1);background:rgba(128,128,128,.04);transition:background .2s}
.dp-ev-item:hover{background:rgba(128,128,128,.08)}
.dp-ev-item.combined-event{border-left:3px solid var(--accent)}
.dp-ev-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.dp-ev-info{flex:1;min-width:0}
.dp-ev-name{font-family:var(--font-body);font-size:.8rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dp-ev-meta{font-family:var(--font-accent);font-size:.7rem;color:var(--accent);opacity:.7}
.dp-ev-del{background:none;border:none;cursor:pointer;color:#ddd;font-size:.85rem;transition:color .2s;flex-shrink:0;padding:4px}
.dp-ev-del:hover{color:#e05050}
.dp-holiday-item{display:flex;align-items:center;gap:8px;padding:7px 11px;border-radius:10px;background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.25);margin-bottom:5px}
.dp-holiday-icon{font-size:1.1rem}
.dp-holiday-name{font-family:var(--font-body);font-size:.78rem;color:#6a4a00;font-style:italic}
.dp-add-btn{padding:4px 12px;font-size:.58rem;margin-top:0;background:var(--accent);color:#fff;border:none;border-radius:8px;font-family:var(--font-body);cursor:pointer;transition:all .25s;letter-spacing:.08em;text-transform:uppercase}
.dp-add-btn:hover{filter:brightness(1.1)}

/* ‚îÄ‚îÄ OVERLAY & PANELS ‚îÄ‚îÄ */
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:700;opacity:0;pointer-events:none;transition:opacity .3s;backdrop-filter:blur(6px)}
#overlay.show{opacity:1;pointer-events:all}
.panel{position:fixed;background:rgba(255,255,255,.97);border-radius:var(--panel-radius);box-shadow:0 24px 70px rgba(0,0,0,.22);z-index:800;padding:24px;transition:opacity .35s cubic-bezier(.34,1.56,.64,1),transform .35s cubic-bezier(.34,1.56,.64,1);opacity:0;pointer-events:none;border:1.5px solid rgba(128,128,128,.1);max-height:92vh;overflow-y:auto}
.panel.show{opacity:1;pointer-events:all}
.panel::-webkit-scrollbar{width:3px}
.panel::-webkit-scrollbar-thumb{background:var(--accent);border-radius:6px}
.p-title{font-family:var(--font-display);font-size:1.6rem;font-style:italic;color:var(--text);margin-bottom:14px}
.p-close{position:absolute;top:12px;right:14px;background:none;border:none;font-size:1.3rem;cursor:pointer;color:#bbb;transition:color .2s,transform .2s}
.p-close:hover{color:var(--accent);transform:rotate(90deg)}
#add-event-panel,#notes-panel,#share-panel,#manage-cals-panel,#holiday-panel,#name-popup-panel{width:min(470px,95vw);top:50%;left:50%;transform:translate(-50%,-50%) scale(.92)}
#add-event-panel.show,#notes-panel.show,#share-panel.show,#manage-cals-panel.show,#holiday-panel.show,#name-popup-panel.show{transform:translate(-50%,-50%) scale(1)}
#combined-panel{width:min(520px,95vw);top:50%;left:50%;transform:translate(-50%,-50%) scale(.92)}
#combined-panel.show{transform:translate(-50%,-50%) scale(1)}
#theme-panel{width:min(760px,96vw);top:50%;left:50%;transform:translate(-50%,-50%) scale(.92)}
#theme-panel.show{transform:translate(-50%,-50%) scale(1)}
#mood-popup{width:min(340px,92vw);top:50%;left:50%;transform:translate(-50%,-50%) scale(.92)}
#mood-popup.show{transform:translate(-50%,-50%) scale(1)}
.f-group{margin-bottom:11px}
.f-label{display:block;font-family:var(--font-body);font-size:.6rem;letter-spacing:.15em;text-transform:uppercase;color:var(--accent);margin-bottom:3px}
.f-input,.f-textarea,.f-select{width:100%;padding:8px 11px;border:1.5px solid rgba(128,128,128,.2);border-radius:9px;font-family:var(--font-body);font-size:.84rem;color:var(--text);background:rgba(240,247,244,.5);outline:none;transition:border-color .2s}
.f-input:focus,.f-textarea:focus,.f-select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(74,143,168,.12)}
.f-textarea{min-height:64px;resize:vertical}
.color-row{display:flex;gap:6px;flex-wrap:wrap}
.c-swatch{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2.5px solid transparent;transition:transform .2s,border-color .2s;flex-shrink:0}
.c-swatch:hover{transform:scale(1.2)}
.c-swatch.sel{border-color:#333}
.submit-btn{width:100%;padding:10px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-family:var(--font-body);font-size:.74rem;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:all .28s;margin-top:5px}
.submit-btn:hover{filter:brightness(1.1);transform:translateY(-2px)}

/* ‚îÄ‚îÄ MOOD POPUP ‚îÄ‚îÄ */
.mood-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
.mood-grid-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 6px;border:2px solid rgba(128,128,128,.12);border-radius:12px;background:none;cursor:pointer;transition:all .2s;font-family:var(--font-body)}
.mood-grid-btn:hover{border-color:var(--accent);background:rgba(74,143,168,.07);transform:translateY(-2px)}
.mood-grid-btn.sel{border-color:var(--accent);background:rgba(74,143,168,.12)}
.mood-grid-btn .me{font-size:1.6rem;line-height:1}
.mood-grid-btn .ml{font-size:.6rem;color:var(--accent);letter-spacing:.05em}
.mood-clear-btn{width:100%;margin-top:10px;padding:8px;border:1.5px solid rgba(128,128,128,.2);border-radius:9px;background:none;color:#aaa;font-family:var(--font-body);font-size:.68rem;cursor:pointer;transition:color .2s}
.mood-clear-btn:hover{color:#e05050;border-color:#e05050}

/* ‚îÄ‚îÄ NAME POPUP ‚îÄ‚îÄ */
.name-popup-body{display:flex;flex-direction:column;gap:12px}
.name-popup-info{font-family:var(--font-body);font-size:.78rem;color:#888;line-height:1.5}

/* ‚îÄ‚îÄ THEME PANEL ‚îÄ‚îÄ */
.theme-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(128px,1fr));gap:8px;margin-top:8px}
.t-card{border-radius:14px;padding:14px 12px;cursor:pointer;transition:all .3s;border:2.5px solid transparent;position:relative;overflow:hidden;min-height:88px}
.t-card:hover{transform:translateY(-5px);box-shadow:0 12px 30px rgba(0,0,0,.18)}
.t-card.active{border-color:rgba(255,255,255,.85);box-shadow:0 0 0 3px rgba(0,0,0,.2),0 12px 30px rgba(0,0,0,.2)}
.t-card.active::after{content:'‚úì';position:absolute;top:8px;right:10px;font-size:.7rem;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.4)}
.t-card-preview{position:absolute;inset:0;border-radius:12px}
.t-card-content{position:relative;z-index:1}
.t-emoji{font-size:1.5rem;margin-bottom:4px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3))}
.t-name{font-family:var(--font-body);font-size:.61rem;letter-spacing:.08em;text-transform:uppercase;font-weight:700;text-shadow:0 1px 4px rgba(0,0,0,.4);color:#fff}
.t-desc{font-size:.57rem;margin-top:1px;opacity:.8;text-shadow:0 1px 3px rgba(0,0,0,.35);color:#fff}

/* ‚îÄ‚îÄ COMBINED CALENDAR PANEL ‚îÄ‚îÄ */
.combined-cal-card{border-radius:12px;padding:13px;border:1px solid rgba(128,128,128,.12);background:rgba(240,247,244,.5);margin-bottom:10px;position:relative}
.ccc-header{display:flex;align-items:center;gap:9px;margin-bottom:9px}
.ccc-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0}
.ccc-name{font-family:var(--font-body);font-size:.85rem;color:var(--text);font-weight:600;flex:1}
.ccc-type-badge{font-size:.56rem;font-family:var(--font-body);letter-spacing:.07em;text-transform:uppercase;padding:2px 7px;border-radius:20px;background:rgba(200,130,10,.12);color:#c8820a}
.ccc-share-row{display:flex;gap:6px;margin-bottom:8px;align-items:center}
.ccc-code-display{flex:1;padding:6px 10px;border:1.5px solid rgba(128,128,128,.18);border-radius:8px;font-family:monospace;font-size:.8rem;background:rgba(255,255,255,.8);color:var(--text);letter-spacing:.1em;font-weight:bold;user-select:all}
.ccc-btn{padding:7px 12px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-family:var(--font-body);font-size:.65rem;cursor:pointer;white-space:nowrap;transition:filter .25s;letter-spacing:.06em;text-transform:uppercase}
.ccc-btn:hover{filter:brightness(1.1)}
.ccc-btn.outline{background:transparent;border:1.5px solid var(--accent);color:var(--accent)}
.ccc-btn.outline:hover{background:var(--accent);color:#fff}
.ccc-btn.danger{background:rgba(224,80,80,.1);border:1.5px solid #e05050;color:#e05050}
.ccc-btn.danger:hover{background:#e05050;color:#fff}
.ccc-members-row{display:flex;flex-wrap:wrap;gap:5px;margin-top:5px}
.ccc-member{padding:3px 9px;border-radius:20px;background:rgba(74,143,168,.1);color:var(--accent);font-family:var(--font-body);font-size:.6rem;letter-spacing:.06em;display:flex;align-items:center;gap:4px}
.ccc-member-del{background:none;border:none;cursor:pointer;color:#bbb;font-size:.65rem;transition:color .2s;padding:0}
.ccc-member-del:hover{color:#e05050}
.join-section{border-top:1px solid rgba(128,128,128,.12);padding-top:14px;margin-top:14px}
.join-row{display:flex;gap:7px;align-items:flex-end}
.ccc-events-section{margin-top:8px;padding-top:8px;border-top:1px dashed rgba(128,128,128,.15)}
.ccc-ev-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;background:rgba(128,128,128,.04);margin-bottom:3px;font-family:var(--font-body);font-size:.72rem}
.ccc-ev-item .ev-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.ccc-ev-del{background:none;border:none;cursor:pointer;color:#ccc;font-size:.7rem;margin-left:auto;transition:color .2s}
.ccc-ev-del:hover{color:#e05050}

/* ‚îÄ‚îÄ HOLIDAY PANEL ‚îÄ‚îÄ */
.holiday-month{margin-bottom:13px}
.holiday-month-name{font-family:var(--font-display);font-size:1.05rem;font-style:italic;color:var(--accent);margin-bottom:5px;padding-bottom:4px;border-bottom:1px solid rgba(128,128,128,.1)}
.holiday-item{display:flex;align-items:center;gap:9px;padding:6px 10px;border-radius:8px;margin-bottom:3px;background:rgba(240,247,244,.5);border:1px solid rgba(128,128,128,.08)}
.holiday-icon{font-size:1.1rem;flex-shrink:0}
.holiday-info{flex:1}
.holiday-name{font-family:var(--font-body);font-size:.78rem;color:var(--text);font-weight:600}
.holiday-date-text{font-family:var(--font-body);font-size:.63rem;color:var(--accent);opacity:.72}

/* ‚îÄ‚îÄ MANAGE CALS ‚îÄ‚îÄ */
.cal-list-section{margin-bottom:13px}
.cal-list-section-title{font-family:var(--font-body);font-size:.6rem;letter-spacing:.18em;text-transform:uppercase;color:var(--accent);padding:5px 0;border-bottom:1px solid rgba(128,128,128,.1);margin-bottom:7px;display:flex;align-items:center;gap:5px}
.cal-item{display:flex;align-items:center;gap:7px;padding:8px 11px;border-radius:10px;background:rgba(240,247,244,.6);margin-bottom:4px;border:1px solid rgba(128,128,128,.1)}
.cal-item-dot{width:11px;height:11px;border-radius:50%;flex-shrink:0}
.cal-item-name{flex:1;font-family:var(--font-body);font-size:.78rem;color:var(--text)}
.cal-item-type{font-size:.54rem;font-family:var(--font-body);letter-spacing:.06em;text-transform:uppercase;padding:2px 6px;border-radius:20px;flex-shrink:0}
.type-personal{background:rgba(74,143,168,.12);color:#4a8fa8}
.type-combined{background:rgba(200,130,10,.12);color:#c8820a}
.type-shared{background:rgba(160,72,120,.12);color:#a04878}
.cal-toggle{width:34px;height:19px;border-radius:10px;background:var(--accent);border:none;cursor:pointer;position:relative;transition:background .25s;flex-shrink:0}
.cal-toggle::after{content:'';position:absolute;width:13px;height:13px;background:#fff;border-radius:50%;top:3px;left:3px;transition:left .25s}
.cal-toggle.off{background:rgba(128,128,128,.26)}
.cal-toggle.off::after{left:18px}
.cal-item-del{background:none;border:none;color:#ccc;cursor:pointer;font-size:.85rem;transition:color .2s;flex-shrink:0}
.cal-item-del:hover{color:#e07070}
.new-cal-section{border-top:1px solid rgba(128,128,128,.12);padding-top:13px;margin-top:4px}
.new-cal-title{font-family:var(--font-body);font-size:.64rem;letter-spacing:.15em;text-transform:uppercase;color:var(--accent);margin-bottom:9px}
.cal-type-row{display:flex;gap:5px;margin-bottom:9px}
.cal-type-btn{flex:1;padding:6px 3px;border:1.5px solid rgba(128,128,128,.16);border-radius:8px;background:transparent;font-family:var(--font-body);font-size:.58rem;letter-spacing:.04em;text-transform:uppercase;cursor:pointer;color:var(--text);transition:all .25s;text-align:center}
.cal-type-btn:hover,.cal-type-btn.selected{background:var(--accent);color:#fff;border-color:var(--accent)}

/* ‚îÄ‚îÄ NOTES ‚îÄ‚îÄ */
.notes-list{max-height:200px;overflow-y:auto;margin-bottom:11px}
.note-item{padding:8px 28px 8px 10px;border-radius:9px;background:rgba(240,247,244,.7);margin-bottom:6px;font-family:var(--font-body);font-size:.78rem;border:1px solid rgba(128,128,128,.1);position:relative;color:var(--text)}
.note-del{position:absolute;right:7px;top:7px;background:none;border:none;cursor:pointer;color:#ccc;font-size:.8rem;transition:color .2s}
.note-del:hover{color:#e07070}
.note-tag{font-size:.58rem;color:var(--accent);margin-bottom:2px;letter-spacing:.1em;text-transform:uppercase}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
#idle-bar{position:fixed;bottom:0;left:0;height:3px;background:var(--accent);z-index:999;width:0%;transition:width 1s linear;opacity:.38;pointer-events:none}
#toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(70px);background:var(--text);color:var(--bg);padding:8px 20px;border-radius:50px;font-family:var(--font-body);font-size:.72rem;letter-spacing:.1em;z-index:1000;transition:transform .38s cubic-bezier(.34,1.56,.64,1);pointer-events:none;white-space:nowrap}
#toast.show{transform:translateX(-50%) translateY(0)}
.piece{position:fixed;pointer-events:none;z-index:1000;border-radius:3px;animation:cF 1.3s ease-out forwards}
@keyframes cF{0%{opacity:1;transform:translateY(0) rotate(0deg)}100%{opacity:0;transform:translateY(88px) rotate(400deg)}}

/* ‚ïê‚ïê‚ïê THEME-SPECIFIC OVERRIDES ‚ïê‚ïê‚ïê */
/* Grunge */
body.theme-grunge .panel,body.theme-grunge #day-panel{background:rgba(18,14,10,.96)!important;color:#d4c8b0!important;border-color:rgba(200,160,96,.3)!important}
body.theme-grunge .f-input,body.theme-grunge .f-textarea,body.theme-grunge .f-select{background:rgba(30,22,14,.7)!important;border-color:rgba(200,160,96,.25)!important;color:#d4c8b0!important}
body.theme-grunge .f-input::placeholder,body.theme-grunge .f-textarea::placeholder{color:rgba(212,200,176,.3)!important}
body.theme-grunge .p-title,body.theme-grunge .dp-date-title,body.theme-grunge .dp-ev-name,body.theme-grunge .dp-holiday-name{color:#c8a060!important}
body.theme-grunge .cal-item,body.theme-grunge .dp-ev-item,body.theme-grunge .dp-mood-row{background:rgba(40,28,16,.6)!important;border-color:rgba(200,160,96,.18)!important}
body.theme-grunge .p-close,body.theme-grunge .dp-close{color:#c8a06088!important}
body.theme-grunge .note-item,body.theme-grunge .combined-cal-card{background:rgba(30,22,14,.7)!important}
body.theme-grunge .f-label,body.theme-grunge .dp-section-title,body.theme-grunge .dp-mood-label{color:#c8a060!important}
body.theme-grunge .holiday-item{background:rgba(255,215,0,.06)!important}
/* Dark Academia */
body.theme-darkacademia .panel,body.theme-darkacademia #day-panel{background:rgba(14,10,6,.97)!important;border-color:rgba(200,168,112,.28)!important}
body.theme-darkacademia .p-title,body.theme-darkacademia .dp-date-title{color:#c8a870!important;font-style:italic}
body.theme-darkacademia .f-input,body.theme-darkacademia .f-textarea,body.theme-darkacademia .f-select{background:rgba(28,20,12,.6)!important;border-color:rgba(200,168,112,.22)!important;color:#e8dcc8!important}
body.theme-darkacademia .dp-ev-name,body.theme-darkacademia .cal-item-name{color:#e8dcc8!important}
body.theme-darkacademia .f-label,body.theme-darkacademia .dp-section-title{color:#c8a870!important}
body.theme-darkacademia .dp-ev-item,body.theme-darkacademia .cal-item,body.theme-darkacademia .dp-mood-row{background:rgba(30,20,10,.5)!important;border-color:rgba(200,168,112,.16)!important}
body.theme-darkacademia .note-item,body.theme-darkacademia .combined-cal-card{background:rgba(28,20,12,.7)!important;color:#e8dcc8!important}
/* Forestcore */
body.theme-forestcore .panel,body.theme-forestcore #day-panel{background:rgba(10,18,8,.97)!important;border-color:rgba(168,192,120,.25)!important}
body.theme-forestcore .p-title,body.theme-forestcore .dp-date-title{color:#a8c078!important}
body.theme-forestcore .f-input,body.theme-forestcore .f-textarea,body.theme-forestcore .f-select{background:rgba(14,26,10,.6)!important;border-color:rgba(168,192,120,.22)!important;color:#d0e0b8!important}
body.theme-forestcore .dp-ev-name,body.theme-forestcore .cal-item-name{color:#d0e0b8!important}
body.theme-forestcore .f-label,body.theme-forestcore .dp-section-title{color:#a8c078!important}
body.theme-forestcore .dp-ev-item,body.theme-forestcore .cal-item,body.theme-forestcore .dp-mood-row{background:rgba(20,34,14,.5)!important;border-color:rgba(168,192,120,.16)!important}
body.theme-forestcore .note-item,body.theme-forestcore .combined-cal-card{background:rgba(14,26,10,.7)!important;color:#d0e0b8!important}
/* Indie */
body.theme-indie .panel,body.theme-indie #day-panel{background:rgba(14,10,6,.97)!important;border-color:rgba(232,160,64,.25)!important}
body.theme-indie .p-title,body.theme-indie .dp-date-title{color:#e8a040!important}
body.theme-indie .f-input,body.theme-indie .f-textarea,body.theme-indie .f-select{background:rgba(26,18,8,.6)!important;border-color:rgba(232,160,64,.22)!important;color:#e8d8c0!important}
body.theme-indie .dp-ev-name,body.theme-indie .cal-item-name{color:#e8d8c0!important}
body.theme-indie .f-label,body.theme-indie .dp-section-title{color:#e8a040!important}
body.theme-indie .dp-ev-item,body.theme-indie .cal-item,body.theme-indie .dp-mood-row{background:rgba(30,18,8,.5)!important;border-color:rgba(232,160,64,.16)!important}
body.theme-indie .note-item,body.theme-indie .combined-cal-card{background:rgba(26,18,8,.7)!important;color:#e8d8c0!important}

/* ‚ïê‚ïê CHEETAH THEME ‚ïê‚ïê */
body.theme-cheetah .panel,body.theme-cheetah #day-panel{background:rgba(12,8,4,.97)!important;border-color:rgba(220,180,60,.3)!important;color:#f0e0a0!important}
body.theme-cheetah .f-input,body.theme-cheetah .f-textarea,body.theme-cheetah .f-select{background:rgba(28,18,6,.7)!important;border-color:rgba(220,180,60,.25)!important;color:#f0e0a0!important}
body.theme-cheetah .f-input::placeholder,body.theme-cheetah .f-textarea::placeholder{color:rgba(240,224,160,.3)!important}
body.theme-cheetah .p-title,body.theme-cheetah .dp-date-title,body.theme-cheetah .dp-ev-name{color:#dca830!important}
body.theme-cheetah .cal-item,body.theme-cheetah .dp-ev-item,body.theme-cheetah .dp-mood-row{background:rgba(36,22,4,.6)!important;border-color:rgba(220,180,60,.2)!important}
body.theme-cheetah .p-close,body.theme-cheetah .dp-close{color:#dca83088!important}
body.theme-cheetah .note-item,body.theme-cheetah .combined-cal-card{background:rgba(28,18,6,.7)!important;color:#f0e0a0!important}
body.theme-cheetah .f-label,body.theme-cheetah .dp-section-title,body.theme-cheetah .dp-mood-label,body.theme-cheetah .dp-ev-meta,body.theme-cheetah .cal-item-name{color:#dca830!important}
body.theme-cheetah .holiday-item{background:rgba(255,215,0,.07)!important}
body.theme-cheetah .note-tag{color:#dca830!important}
body.theme-cheetah .name-popup-info{color:#c0a060!important}
body.theme-cheetah .dp-mood-clear{color:#906030!important}
body.theme-cheetah .dp-holiday-name{color:#a07020!important}

@media(max-width:640px){
  .cal-day{min-height:56px;padding:3px 3px 2px}
  .d-num{font-size:.78rem;width:20px;height:20px}
  .ev-chip,.d-labels{display:none}
  .cal-header{flex-direction:column;align-items:flex-start}
  .cal-sections-wrap{flex-direction:column}
  .clock-glass{padding:22px 26px 18px}
}
::selection{background:var(--accent);color:#fff}

/* ‚ïê‚ïê‚ïê COMBINED SCREEN ‚Äî full separate calendar ‚ïê‚ïê‚ïê */
#combined-screen{justify-content:flex-start;overflow:hidden;padding:0;z-index:2;background:transparent;display:flex;flex-direction:column}
/* Combined header */
.cs-header{width:100%;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;gap:8px;position:relative;z-index:10;flex-shrink:0}
.cs-header-glass{position:absolute;inset:0;background:rgba(255,255,255,.12);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.18);z-index:-1}
.cs-title{font-family:var(--font-display);font-size:1.25rem;font-style:italic;color:var(--text);line-height:1}
.cs-subtitle{font-family:var(--font-body);font-size:.52rem;letter-spacing:.18em;text-transform:uppercase;color:var(--accent);opacity:.65}
.cs-back-btn{padding:7px 14px;border:1.5px solid var(--accent);background:rgba(255,255,255,.12);backdrop-filter:blur(8px);border-radius:var(--btn-border-radius,50px);color:var(--text);font-family:var(--font-body);font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:all .25s;white-space:nowrap}
.cs-back-btn:hover{background:var(--accent);color:#fff}
.cs-month-nav{display:flex;align-items:center;gap:8px}
/* Identity strip */
.cs-identity-strip{width:100%;display:flex;align-items:center;justify-content:space-between;padding:7px 14px;background:rgba(255,255,255,.08);border-bottom:1px solid rgba(255,255,255,.1);flex-shrink:0}
.cs-identity-left{display:flex;align-items:center;gap:9px}
.cs-user-avatar{width:30px;height:30px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.9rem;color:#fff;font-family:var(--font-display);font-style:italic;font-weight:700;flex-shrink:0}
.cs-user-name-wrap{display:flex;flex-direction:column}
.cs-you-label{font-family:var(--font-body);font-size:.52rem;letter-spacing:.1em;text-transform:uppercase;color:var(--accent);opacity:.55}
.cs-you-name{font-family:var(--font-display);font-size:.9rem;font-style:italic;color:var(--text)}
.cs-identity-right{display:flex;align-items:center;gap:7px}
.cs-signed-as{font-family:var(--font-body);font-size:.52rem;letter-spacing:.1em;text-transform:uppercase;color:var(--accent);opacity:.45}
.cs-signed-name{font-family:var(--font-display);font-size:.85rem;font-style:italic;color:var(--text)}
.cs-name-edit{background:none;border:1px solid rgba(128,128,128,.22);color:var(--accent);font-family:var(--font-body);font-size:.55rem;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;opacity:.6;transition:all .2s;padding:3px 9px;border-radius:20px}
.cs-name-edit:hover{opacity:1;border-color:var(--accent)}
/* Combined calendar grid */
.cs-cal-grid-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0;padding:0 8px}
.cs-cal-grid-wrap .cal-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;padding:4px 0 2px}
.cs-cal-grid-wrap .cal-days{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;flex:1;overflow-y:auto}
/* Bottom slide-up drawer */
.cs-drawer{position:relative;flex-shrink:0;background:rgba(255,255,255,.08);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,.16);max-height:52px;overflow:hidden;transition:max-height .5s cubic-bezier(.4,0,.2,1)}
.cs-drawer.open{max-height:75vh;overflow-y:auto}
.cs-drawer::-webkit-scrollbar{width:3px}
.cs-drawer::-webkit-scrollbar-thumb{background:var(--accent);border-radius:8px}
.cs-drawer-handle{display:flex;align-items:center;justify-content:center;gap:10px;padding:10px 14px;cursor:pointer;position:sticky;top:0;background:inherit;z-index:2}
.cs-drawer-pill{width:36px;height:4px;border-radius:4px;background:rgba(128,128,128,.3)}
.cs-drawer-label{font-family:var(--font-body);font-size:.57rem;letter-spacing:.14em;text-transform:uppercase;color:var(--accent);opacity:.6}
.cs-drawer-body{padding:10px 14px 24px;display:flex;flex-direction:column;gap:12px}
/* Inside drawer */
.cs-user-bar{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:12px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18)}
.cs-user-avatar-lg{width:40px;height:40px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:1.1rem;color:#fff;font-family:var(--font-display);font-style:italic;font-weight:700;flex-shrink:0}
.cs-user-name-main{font-family:var(--font-display);font-size:1.1rem;font-style:italic;color:var(--text)}
.cs-user-name-sub{font-family:var(--font-body);font-size:.56rem;letter-spacing:.1em;text-transform:uppercase;color:var(--accent);opacity:.5;margin-top:1px}
.cs-cals-wrap{display:flex;flex-direction:column;gap:12px}
.cs-cal-card{border-radius:14px;background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.18);overflow:hidden}
.cs-cal-card-header{padding:12px 16px 10px;display:flex;align-items:center;gap:9px;border-bottom:1px solid rgba(255,255,255,.1)}
.cs-cal-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0}
.cs-cal-name{font-family:var(--font-display);font-size:1.05rem;font-style:italic;color:var(--text);flex:1}
.cs-cal-badge{font-size:.52rem;font-family:var(--font-body);letter-spacing:.07em;text-transform:uppercase;padding:3px 8px;border-radius:20px;background:rgba(200,130,10,.15);color:#c8820a}
.cs-cal-body{padding:12px 16px}
.cs-invite-section{background:rgba(255,255,255,.07);border-radius:10px;padding:10px 12px;margin-bottom:10px;border:1px solid rgba(255,255,255,.12)}
.cs-invite-label{font-family:var(--font-body);font-size:.52rem;letter-spacing:.14em;text-transform:uppercase;color:var(--accent);opacity:.65;margin-bottom:6px}
.cs-invite-row{display:flex;gap:6px;align-items:center}
.cs-code{flex:1;padding:7px 11px;border-radius:8px;background:rgba(0,0,0,.12);font-family:monospace;font-size:.85rem;font-weight:700;color:var(--text);letter-spacing:.14em;border:1px solid rgba(255,255,255,.15);user-select:all}
.cs-action-btn{padding:7px 13px;background:var(--accent);color:#fff;border:none;border-radius:var(--btn-border-radius,50px);font-family:var(--font-body);font-size:.6rem;cursor:pointer;white-space:nowrap;transition:all .25s;letter-spacing:.07em;text-transform:uppercase;flex-shrink:0}
.cs-action-btn:hover{filter:brightness(1.1);transform:translateY(-1px)}
.cs-action-btn.outline{background:transparent;border:1.5px solid var(--accent);color:var(--accent)}
.cs-action-btn.outline:hover{background:var(--accent);color:#fff}
.cs-action-btn.danger{background:transparent;border:1.5px solid rgba(224,80,80,.6);color:#e05050}
.cs-action-btn.danger:hover{background:#e05050;color:#fff}
.cs-members-section{margin-bottom:10px}
.cs-members-label{font-family:var(--font-body);font-size:.52rem;letter-spacing:.14em;text-transform:uppercase;color:var(--accent);opacity:.65;margin-bottom:5px}
.cs-members-list{display:flex;flex-wrap:wrap;gap:5px}
.cs-member-chip{display:flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.18);font-family:var(--font-body);font-size:.62rem;color:var(--text)}
.cs-member-chip.is-you{background:rgba(74,143,168,.16);border-color:rgba(74,143,168,.28);color:var(--accent)}
.cs-member-avatar{width:16px;height:16px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.6rem;color:#fff;flex-shrink:0}
.cs-member-del{background:none;border:none;cursor:pointer;color:rgba(128,128,128,.4);font-size:.65rem;transition:color .2s;padding:0 0 0 3px}
.cs-member-del:hover{color:#e05050}
.cs-events-section{border-top:1px solid rgba(255,255,255,.1);padding-top:10px}
.cs-events-label{font-family:var(--font-body);font-size:.52rem;letter-spacing:.14em;text-transform:uppercase;color:var(--accent);opacity:.65;margin-bottom:7px}
.cs-ev-list{display:flex;flex-direction:column;gap:4px}
.cs-ev-item{display:flex;align-items:center;gap:8px;padding:8px 11px;border-radius:9px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);transition:background .2s}
.cs-ev-item:hover{background:rgba(255,255,255,.13)}
.cs-ev-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.cs-ev-info{flex:1;min-width:0}
.cs-ev-title{font-family:var(--font-body);font-size:.76rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cs-ev-meta{font-family:var(--font-accent);font-size:.65rem;color:var(--accent);opacity:.65}
.cs-ev-name-badge{font-size:.55rem;padding:2px 7px;border-radius:10px;background:rgba(74,143,168,.15);color:var(--accent);font-family:var(--font-body);letter-spacing:.04em;border:1px solid rgba(74,143,168,.2);flex-shrink:0}
.cs-ev-name-badge.is-you{background:rgba(100,200,100,.12);color:#4a8a50;border-color:rgba(100,200,100,.2)}
.cs-ev-del{background:none;border:none;cursor:pointer;color:rgba(128,128,128,.3);font-size:.75rem;transition:color .2s;flex-shrink:0;padding:4px}
.cs-ev-del:hover{color:#e05050}
.cs-no-events{font-family:var(--font-accent);font-size:.85rem;color:var(--accent);opacity:.3;text-align:center;padding:8px 0}
.cs-add-event-btn{width:100%;padding:9px;background:rgba(255,255,255,.08);border:1.5px dashed rgba(255,255,255,.22);border-radius:9px;color:var(--text);font-family:var(--font-body);font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:all .25s;margin-top:7px;opacity:.55}
.cs-add-event-btn:hover{opacity:1;background:rgba(255,255,255,.15);border-style:solid}
.cs-new-cal-wrap{border-radius:12px;background:rgba(255,255,255,.06);border:1.5px dashed rgba(255,255,255,.18);padding:16px 20px;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:10px}
.cs-new-cal-wrap:hover{background:rgba(255,255,255,.12);border-style:solid;transform:translateY(-2px)}
.cs-new-cal-icon{font-size:1.2rem;opacity:.45}
.cs-new-cal-text{font-family:var(--font-display);font-style:italic;font-size:.95rem;color:var(--text);opacity:.5}
.cs-join-wrap{border-radius:12px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.15);padding:12px 16px}
.cs-join-label{font-family:var(--font-body);font-size:.52rem;letter-spacing:.14em;text-transform:uppercase;color:var(--accent);opacity:.65;margin-bottom:7px}
.cs-join-row{display:flex;gap:7px}
/* Day panel in combined screen ‚Äî share panel */
#cs-day-panel-overlay{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.35);backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:opacity .3s}
#cs-day-panel-overlay.show{opacity:1;pointer-events:all}
#cs-day-panel{position:fixed;right:-380px;top:0;bottom:0;width:340px;max-width:92vw;z-index:101;background:rgba(255,255,255,.14);backdrop-filter:blur(28px);-webkit-backdrop-filter:blur(28px);border-left:1px solid rgba(255,255,255,.2);padding:20px 18px;overflow-y:auto;transition:right .38s cubic-bezier(.4,0,.2,1);box-shadow:-12px 0 48px rgba(0,0,0,.18)}
#cs-day-panel.show{right:0}
/* NAME SETUP SCREEN */
#name-setup-screen{z-index:20;background:transparent}
.ns-card{background:rgba(255,255,255,.14);backdrop-filter:blur(28px);-webkit-backdrop-filter:blur(28px);border:1px solid rgba(255,255,255,.22);border-radius:28px;padding:40px 48px;max-width:460px;width:90%;text-align:center;box-shadow:0 24px 64px rgba(0,0,0,.2)}
.ns-icon{font-size:2.8rem;margin-bottom:12px;filter:drop-shadow(0 4px 12px rgba(0,0,0,.25))}
.ns-title{font-family:var(--font-display);font-size:2.2rem;font-style:italic;color:var(--clock-tc);margin-bottom:6px}
.ns-subtitle{font-family:var(--font-accent);font-size:1rem;color:var(--clock-sub);opacity:.7;margin-bottom:24px}
.ns-input{width:100%;padding:12px 16px;border:1.5px solid rgba(255,255,255,.3);border-radius:12px;font-family:var(--font-display);font-size:1.1rem;font-style:italic;color:var(--clock-tc);background:rgba(255,255,255,.18);outline:none;text-align:center;transition:border-color .2s}
.ns-input:focus{border-color:var(--accent)}
.ns-input::placeholder{opacity:.4}
.ns-btn{width:100%;margin-top:14px;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:12px;font-family:var(--font-body);font-size:.76rem;letter-spacing:.12em;text-transform:uppercase;cursor:pointer;transition:all .28s}
.ns-btn:hover{filter:brightness(1.1);transform:translateY(-2px)}
.ns-skip{margin-top:10px;font-family:var(--font-body);font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;color:var(--clock-sub);opacity:.4;cursor:pointer;transition:opacity .2s}
.ns-skip:hover{opacity:.7}

</style>
</head>
<body data-theme="coastal">

<div id="theme-bg-el" class="theme-bg"></div>
<div id="theme-overlay-el" class="theme-bg-overlay"></div>
<div id="grain-overlay"></div>
<canvas id="particle-canvas"></canvas>
<div id="cursor"></div><div id="cursor-dot"></div>
<div id="idle-bar"></div>
<div id="overlay"></div>
<div id="tooltip" class="tooltip"></div>
<div id="toast"></div>

<!-- ‚ïê‚ïê NAME SETUP SCREEN ‚ïê‚ïê -->
<div class="screen hidden" id="name-setup-screen">
  <div class="ns-card" id="ns-card">
    <div class="ns-icon">‚ú¶</div>
    <div class="ns-title">Welcome</div>
    <div class="ns-subtitle">What shall we call you?</div>
    <input class="ns-input" id="ns-name-input" placeholder="Your name..." maxlength="32" autocomplete="off">
    <button class="ns-btn" id="ns-confirm-btn">Start Planning ‚ú¶</button>
    <div class="ns-skip" id="ns-skip-btn">skip for now</div>
  </div>
</div>

<!-- ‚ïê‚ïê IDLE / CLOCK ‚ïê‚ïê -->
<div class="screen hidden" id="clock-screen">
  <div class="clock-inner">
    <div class="clock-glass" id="clock-glass">
      <div class="clock-time" id="clock-time">00:00</div>
      <div class="clock-date" id="clock-date"></div>
      <div class="clock-theme-tag" id="clock-theme-tag"></div>
      <div class="clock-mood-strip">
        <div class="clock-mood-display" id="clock-mood-display" title="Click to set today's mood">‚òÄÔ∏è</div>
        <div class="clock-mood-label" id="clock-mood-label"></div>
      </div>
    </div>
    <div class="idle-events-wrap">
      <div class="idle-events-title">Today's Events &amp; Holidays</div>
      <div class="idle-ev-list" id="idle-ev-list"></div>
    </div>
    <div class="clock-hint">move mouse to open calendar ‚ú¶</div>
  </div>
</div>

<!-- ‚ïê‚ïê CALENDAR ‚ïê‚ïê -->
<div class="screen hidden" id="calendar-screen">
  <div class="cal-header" id="cal-header">
    <div class="cal-header-glass"></div>
    <div style="padding:0 8px">
      <div class="cal-month-name" id="cal-month"></div>
      <div class="cal-year" id="cal-year"></div>
    </div>
    <div class="cal-nav">
      <button class="nav-btn" id="btn-prev">&#8249;</button>
      <button class="nav-btn" id="btn-today">&#9711;</button>
      <button class="nav-btn" id="btn-next">&#8250;</button>
    </div>
    <div class="cal-actions">
      <button class="action-btn" id="btn-add">+ Event</button>
      <button class="action-btn" id="btn-notes">Notes</button>
      <button class="action-btn" id="btn-holidays">Holidays</button>
      <button class="action-btn" id="btn-combined">üîó Combined ‚ú¶</button>
      <button class="action-btn" id="btn-theme">Themes</button>
      <button class="action-btn" id="btn-manage-cals">Manage</button>
      <button class="time-toggle" id="btn-time-toggle">12h</button>
    </div>
  </div>
  <div class="cal-sections-wrap">
    <div class="cal-section">
      <div class="cal-section-label">üë§ Personal</div>
      <div class="cal-section-tabs" id="personal-tabs"></div>
    </div>
  </div>
  <div class="month-banner" id="month-banner"></div>
  <div class="cal-grid-wrap">
    <div class="cal-weekdays">
      <div class="cal-weekday">Sun</div><div class="cal-weekday">Mon</div>
      <div class="cal-weekday">Tue</div><div class="cal-weekday">Wed</div>
      <div class="cal-weekday">Thu</div><div class="cal-weekday">Fri</div>
      <div class="cal-weekday">Sat</div>
    </div>
    <div class="cal-days" id="cal-days"></div>
  </div>
</div>

<!-- ‚ïê‚ïê COMBINED SCREEN ‚Äî full separate calendar ‚ïê‚ïê -->
<div class="screen hidden" id="combined-screen">

  <!-- TOP HEADER BAR -->
  <div class="cs-header" id="cs-header">
    <div class="cs-header-glass"></div>
    <!-- Left: back + title -->
    <div style="display:flex;align-items:center;gap:12px;padding:0 6px;min-width:0">
      <button class="cs-back-btn" id="cs-back-btn">‚Üê Personal</button>
      <div>
        <div class="cs-title" id="cs-cal-title">Combined ‚ú¶</div>
        <div class="cs-subtitle" id="cs-cal-subtitle">Shared Calendars</div>
      </div>
    </div>
    <!-- Centre: month nav -->
    <div class="cs-month-nav">
      <button class="nav-btn" id="cs-btn-prev">&#8249;</button>
      <div style="text-align:center;min-width:100px">
        <div class="cal-month-name" id="cs-month-label" style="font-size:1rem"></div>
        <div class="cal-year" id="cs-year-label" style="font-size:.7rem"></div>
      </div>
      <button class="nav-btn" id="cs-btn-next">&#8250;</button>
    </div>
    <!-- Right: actions -->
    <div style="display:flex;gap:6px;align-items:center;padding:0 6px;flex-shrink:0">
      <button class="action-btn" id="cs-add-event-btn">+ Event</button>
      <button class="action-btn" id="cs-manage-btn">Manage ‚ú¶</button>
    </div>
  </div>

  <!-- WHO YOU ARE ‚Äî identity strip -->
  <div class="cs-identity-strip">
    <div class="cs-identity-left">
      <div class="cs-user-avatar" id="cs-avatar">?</div>
      <div class="cs-user-name-wrap">
        <span class="cs-you-label">Showing events for</span>
        <span class="cs-you-name" id="cs-name-display">All Members</span>
      </div>
    </div>
    <div class="cs-identity-right">
      <span class="cs-signed-as">Signed in as</span>
      <span class="cs-signed-name" id="cs-signed-name">Anonymous</span>
      <button class="cs-name-edit" id="cs-name-edit-btn">‚úè Edit</button>
    </div>
  </div>

  <!-- COMBINED CALENDAR GRID -->
  <div class="cs-cal-grid-wrap">
    <div class="cal-weekdays">
      <div class="cal-weekday">Sun</div><div class="cal-weekday">Mon</div>
      <div class="cal-weekday">Tue</div><div class="cal-weekday">Wed</div>
      <div class="cal-weekday">Thu</div><div class="cal-weekday">Fri</div>
      <div class="cal-weekday">Sat</div>
    </div>
    <div class="cal-days" id="cs-cal-days"></div>
  </div>

  <!-- BOTTOM DRAWER ‚Äî calendar cards, join, new -->
  <div class="cs-drawer" id="cs-drawer">
    <div class="cs-drawer-handle" id="cs-drawer-handle">
      <div class="cs-drawer-pill"></div>
      <span class="cs-drawer-label">Calendars &amp; Settings</span>
    </div>
    <div class="cs-drawer-body" id="cs-drawer-body">
      <!-- User bar full -->
      <div class="cs-user-bar">
        <div class="cs-user-avatar-lg" id="cs-avatar-lg">?</div>
        <div style="flex:1">
          <div class="cs-user-name-main" id="cs-name-main">Anonymous</div>
          <div class="cs-user-name-sub">Your name on combined events</div>
        </div>
        <button class="cs-name-edit" id="cs-name-edit-btn2">‚úè Edit Name</button>
      </div>
      <!-- Join section -->
      <div class="cs-join-wrap">
        <div class="cs-join-label">Join with Invite Code</div>
        <div class="cs-join-row">
          <input class="f-input" id="cs-join-input" placeholder="Paste code or link..." style="flex:1;min-width:0">
          <button class="cs-action-btn" id="cs-join-btn">Join ‚ú¶</button>
        </div>
      </div>
      <!-- Calendar list -->
      <div class="cs-cals-wrap" id="cs-cals-wrap"></div>
      <!-- New button -->
      <div class="cs-new-cal-wrap" id="cs-new-cal-btn">
        <div class="cs-new-cal-icon">Ôºã</div>
        <div class="cs-new-cal-text">Create a new combined calendar</div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê COMBINED SCREEN DAY PANEL ‚ïê‚ïê -->
<div id="cs-day-panel-overlay"></div>
<div id="cs-day-panel">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
    <div class="dp-date-title" id="cs-dp-date-title" style="font-size:1rem"></div>
    <button class="dp-close" id="cs-dp-close">&#x2715;</button>
  </div>
  <div class="dp-section-title" style="margin-bottom:8px">Events on this day</div>
  <div id="cs-dp-ev-list"></div>
  <button class="submit-btn" id="cs-dp-add-btn" style="margin-top:16px;font-size:.68rem;padding:10px">+ Add Event ‚ú¶</button>
</div>

<!-- ‚ïê‚ïê COMBINED MANAGE PANEL ‚ïê‚ïê -->
<div class="panel" id="combined-manage-panel">
  <button class="p-close" id="close-combined-manage">&#x2715;</button>
  <div class="p-title">Combined Calendars ‚ú¶</div>
  <p style="font-family:var(--font-body);font-size:.72rem;opacity:.48;margin-bottom:14px;line-height:1.7">Create shared calendars with friends. Share the invite link ‚Äî they tap it and are taken straight to your calendar with the code pre-filled.</p>
  <div id="combined-manage-list"></div>
  <div class="join-section" style="margin-top:14px">
    <div class="f-group">
      <label class="f-label">Join with a Code or Link</label>
      <div class="join-row">
        <input class="f-input" id="manage-join-input" placeholder="Paste code or link...">
        <button class="submit-btn" style="width:auto;padding:8px 16px;margin-top:0;flex-shrink:0" id="manage-join-btn">Join ‚ú¶</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê DAY DETAIL PANEL ‚ïê‚ïê -->
<div id="day-panel">
  <div class="dp-photo-header" id="dp-photo-header">
    <img class="dp-photo-img" id="dp-photo-img" alt="Day photo">
    <div class="dp-photo-placeholder" id="dp-photo-placeholder">
      <span>üì∑</span><p>Add a photo for this day</p>
    </div>
    <button class="dp-photo-change" id="dp-photo-change" style="display:none">Change Photo</button>
    <input type="file" accept="image/*" id="dp-photo-input">
  </div>
  <div class="dp-body">
    <div class="dp-date-row">
      <div class="dp-date-title" id="dp-date-title">January 1</div>
      <button class="dp-close" id="close-day">&#x2715;</button>
    </div>
    <div class="dp-mood-row" id="dp-mood-row">
      <div class="dp-mood-label">Mood</div>
      <div class="dp-mood-emojis" id="dp-mood-emojis"></div>
      <button class="dp-mood-clear" id="dp-mood-clear">Clear</button>
    </div>
    <div class="dp-section-title">Holidays</div>
    <div id="dp-holidays"></div>
    <div class="dp-section-title">
      Events
      <button class="dp-add-btn" id="dp-quick-add">+ Add</button>
    </div>
    <div class="dp-ev-list" id="dp-ev-list"></div>
  </div>
</div>

<!-- ‚ïê‚ïê ADD EVENT PANEL ‚ïê‚ïê -->
<div class="panel" id="add-event-panel">
  <button class="p-close" id="close-add">&#x2715;</button>
  <div class="p-title">Add Event ‚ú¶</div>
  <div class="f-group"><label class="f-label">Title</label><input class="f-input" id="ev-title" placeholder="e.g. Afternoon tea..."></div>
  <div class="f-group"><label class="f-label">Date</label><input class="f-input" id="ev-date" type="date"></div>
  <div class="f-group"><label class="f-label">Time <span style="opacity:.4;font-size:.8em">(optional)</span></label><input class="f-input" id="ev-time" type="time"></div>
  <div class="f-group"><label class="f-label">Note</label><textarea class="f-textarea" id="ev-note" placeholder="Details..."></textarea></div>
  <div class="f-group"><label class="f-label">Calendar</label><select class="f-select" id="ev-cal-select"></select></div>
  <div class="f-group"><label class="f-label">Colour</label><div class="color-row" id="color-row"></div></div>
  <button class="submit-btn" id="btn-save-ev">Save Event ‚ú¶</button>
</div>

<!-- ‚ïê‚ïê NOTES PANEL ‚ïê‚ïê -->
<div class="panel" id="notes-panel">
  <button class="p-close" id="close-notes">&#x2715;</button>
  <div class="p-title">Notes ‚ú¶</div>
  <div class="notes-list" id="notes-list"></div>
  <div class="f-group"><label class="f-label">New note</label><textarea class="f-textarea" id="note-text" placeholder="Write something..."></textarea></div>
  <div class="f-group"><label class="f-label">Date tag</label><input class="f-input" id="note-date" type="date"></div>
  <button class="submit-btn" id="btn-save-note">Save Note ‚ú¶</button>
</div>

<!-- ‚ïê‚ïê THEME PANEL ‚ïê‚ïê -->
<div class="panel" id="theme-panel">
  <button class="p-close" id="close-theme">&#x2715;</button>
  <div class="p-title">Choose Aesthetic ‚ú¶</div>
  <div class="theme-grid" id="theme-grid"></div>
</div>

<!-- ‚ïê‚ïê MANAGE CALENDARS PANEL ‚ïê‚ïê -->
<div class="panel" id="manage-cals-panel">
  <button class="p-close" id="close-manage-cals">&#x2715;</button>
  <div class="p-title">My Calendars ‚ú¶</div>
  <div id="cal-list"></div>
  <div class="new-cal-section">
    <div class="new-cal-title">+ New Calendar</div>
    <div class="f-group"><label class="f-label">Name</label><input class="f-input" id="new-cal-name" placeholder="e.g. Family, Work..."></div>
    <div class="f-group"><label class="f-label">Type</label>
      <div class="cal-type-row">
        <button class="cal-type-btn selected" data-type="personal">üë§ Personal</button>
        <button class="cal-type-btn" data-type="combined">üîó Combined</button>
      </div>
    </div>
    <div class="f-group"><label class="f-label">Colour</label><div class="color-row" id="cal-color-row"></div></div>
    <button class="submit-btn" id="btn-save-cal">Create Calendar ‚ú¶</button>
  </div>
</div>

<!-- ‚ïê‚ïê HOLIDAY PANEL ‚ïê‚ïê -->
<div class="panel" id="holiday-panel">
  <button class="p-close" id="close-holiday">&#x2715;</button>
  <div class="p-title">Holidays ‚ú¶</div>
  <p style="font-family:var(--font-body);font-size:.74rem;opacity:.5;margin-bottom:12px">US Federal &amp; Popular Holidays</p>
  <div id="holiday-list"></div>
</div>

<!-- ‚ïê‚ïê MOOD POPUP ‚ïê‚ïê -->
<div class="panel" id="mood-popup">
  <button class="p-close" id="close-mood">&#x2715;</button>
  <div class="p-title">How are you feeling? ‚ú¶</div>
  <div id="mood-date-label" style="font-family:var(--font-accent);font-size:1rem;color:var(--accent);opacity:.7;margin-bottom:10px"></div>
  <div class="mood-grid" id="mood-popup-grid"></div>
  <button class="mood-clear-btn" id="mood-popup-clear">Clear mood</button>
</div>

<!-- ‚ïê‚ïê NAME EDIT POPUP ‚ïê‚ïê -->
<div class="panel" id="name-edit-panel">
  <button class="p-close" id="close-name-edit">&#x2715;</button>
  <div class="p-title">Your Name ‚ú¶</div>
  <p style="font-family:var(--font-body);font-size:.76rem;opacity:.5;margin-bottom:14px;line-height:1.6">Your name appears on all events you add to combined calendars, so friends know who added what.</p>
  <div class="f-group"><label class="f-label">Name / Label</label><input class="f-input" id="name-edit-input" placeholder="e.g. Sarah, Mom, Work..."></div>
  <button class="submit-btn" id="btn-save-name-edit">Save ‚ú¶</button>
</div>

<!-- ‚ïê‚ïê NEW COMBINED CAL POPUP ‚ïê‚ïê -->
<div class="panel" id="new-combined-panel">
  <button class="p-close" id="close-new-combined">&#x2715;</button>
  <div class="p-title">New Combined Calendar ‚ú¶</div>
  <div class="f-group"><label class="f-label">Calendar Name</label><input class="f-input" id="nc-name" placeholder="e.g. Family, Trip, Book Club..."></div>
  <div class="f-group"><label class="f-label">Colour</label><div class="color-row" id="nc-color-row"></div></div>
  <button class="submit-btn" id="btn-create-combined">Create &amp; Get Invite Code ‚ú¶</button>
</div>

<script>

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HOLIDAY DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const FIXED_HOLIDAYS=[
  [1,1,"New Year's Day","üéÜ"],[1,20,"Martin Luther King Jr. Day","‚úä"],
  [2,14,"Valentine's Day","üíå"],[2,17,"Presidents' Day","üèõÔ∏è"],
  [3,17,"St. Patrick's Day","üçÄ"],[4,1,"April Fools' Day","üÉè"],
  [4,22,"Earth Day","üåç"],[5,5,"Cinco de Mayo","üåÆ"],
  [5,11,"Mother's Day","üíê"],[5,26,"Memorial Day","üá∫üá∏"],
  [6,14,"Flag Day","üö©"],[6,15,"Father's Day","üëî"],
  [6,19,"Juneteenth","‚úä"],[7,4,"Independence Day","üéá"],
  [9,1,"Labor Day","‚öíÔ∏è"],[10,13,"Columbus Day","üß≠"],
  [10,31,"Halloween","üéÉ"],[11,11,"Veterans Day","üéñÔ∏è"],
  [11,27,"Thanksgiving","ü¶É"],[12,7,"Pearl Harbor Day","‚öì"],
  [12,24,"Christmas Eve","üéÑ"],[12,25,"Christmas Day","üéÑ"],
  [12,26,"Kwanzaa Begins","üïØÔ∏è"],[12,31,"New Year's Eve","ü•Ç"],
];
function getDynHolidays(yr){
  const a=yr%19,b=Math.floor(yr/100),c=yr%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),hh=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-hh-k)%7,m2=Math.floor((a+11*hh+22*l)/451),month=Math.floor((hh+l-7*m2+114)/31),day=((hh+l-7*m2+114)%31)+1;
  return[[month,day,"Easter Sunday","üê£"],[12,14,"Hanukkah Begins","üïé"]];
}
function getHolsForDate(yr,mo,day){const m=mo+1;return[...FIXED_HOLIDAYS,...getDynHolidays(yr)].filter(h=>h[0]===m&&h[1]===day);}
function getHolsForMonth(yr,mo){const m=mo+1;return[...FIXED_HOLIDAYS,...getDynHolidays(yr)].filter(h=>h[0]===m).sort((a,b)=>a[1]-b[1]);}
function getAllHols(yr){return[...FIXED_HOLIDAYS,...getDynHolidays(yr)].sort((a,b)=>a[0]-b[0]||a[1]-b[1]);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOODS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const MOODS=[
  {e:'üòÑ',l:'Happy'},{e:'üòå',l:'Calm'},{e:'üòç',l:'Loved'},{e:'ü•≥',l:'Festive'},
  {e:'üò¢',l:'Sad'},{e:'üò§',l:'Frustrated'},{e:'üò¥',l:'Tired'},{e:'ü§í',l:'Unwell'},
  {e:'‚ú®',l:'Inspired'},{e:'üòê',l:'Meh'},{e:'üî•',l:'Motivated'},{e:'üåø',l:'Peaceful'},
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   THEMES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const THEMES=[
  {id:'coastal',emoji:'üåä',name:'Coastal',desc:'Salt & sea breeze',
   cls:'',grain:0,
   vars:{accent:'#4a8fa8',bg:'#eaf4fb',text:'#1a3d52','font-display':"'DM Serif Display',serif",'font-body':"'Josefin Sans',sans-serif",'font-accent':"'Caveat',cursive",'clock-tc':'#1a3d52','clock-sub':'#4a8fa8','btn-border-radius':'50px','panel-radius':'22px'},
   bg:'background:linear-gradient(180deg,#a8d8ea,#d4eef8 40%,#e8f4fb 70%,#c8d8e8)',
   ov:'background:url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Cpath d=\'M0 150 Q50 120 100 150 Q150 180 200 150 L200 200 L0 200Z\' fill=\'rgba(72,160,200,.07)\'/%3E%3C/svg%3E") repeat-x bottom/200px',
   glass:'background:rgba(200,230,250,.25)',
   months:['Soft Tides','Sea Mist','Driftwood','Sandy Shores','Coral Bloom','Sun & Salt','High Tide','Seafoam','Shell Pink','Harvest Bay','Foggy Cove','Winter Shore']},

  {id:'coquette',emoji:'üéÄ',name:'Coquette',desc:'Bow & blush dreams',
   cls:'',grain:.08,
   vars:{accent:'#c96080',bg:'#fce8f0',text:'#5c2a38','font-display':"'Bodoni Moda',serif",'font-body':"'Raleway',sans-serif",'font-accent':"'Sacramento',cursive",'clock-tc':'#5c2a38','clock-sub':'#c96080','btn-border-radius':'4px','panel-radius':'14px'},
   bg:'background:radial-gradient(ellipse at 40% 0%,#fbd5e6 0%,#f8c8db 30%,#fbdae8 60%,#f5c0d4 100%)',
   ov:'background-image:radial-gradient(circle at 15% 25%,rgba(255,182,193,.5),transparent 40%),radial-gradient(circle at 85% 75%,rgba(220,100,130,.15),transparent 45%)',
   glass:'background:rgba(252,216,230,.45);border-color:rgba(201,96,128,.25) !important',
   months:['Pink Reverie','Ribbon & Lace','Blush March','Cherry Blossom','Petal Pink','Bow Season','Pastel Dream','Rosy August','Velvet Bloom','Autumn Blush','Mauve November','Candy Crush']},

  {id:'grunge',emoji:'üñ§',name:'Grunge',desc:'Distorted & raw',
   cls:'theme-grunge',grain:.55,
   vars:{accent:'#c8a060',bg:'#0a0806',text:'#d4c8b0','font-display':"'UnifrakturMaguntia',cursive",'font-body':"'Space Mono',monospace",'font-accent':"'Caveat',cursive",'clock-tc':'#c8a060','clock-sub':'#d4c8b0','btn-border-radius':'0px','panel-radius':'4px'},
   bg:'background:#0a0806;background-image:linear-gradient(175deg,#1e1a16 0%,#0a0806 55%,#1a0c08 100%)',
   ov:'background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(200,160,96,.018) 2px,rgba(200,160,96,.018) 4px)',
   glass:'background:rgba(20,14,8,.72);border:1px solid rgba(200,160,96,.3) !important;box-shadow:4px 4px 0 rgba(0,0,0,.6) !important',
   months:['Static January','Raw February','Torn March','Rust April','Smoky May','Acid June','Broken July','Haze August','Decay September','Hollow October','Numb November','Cold Static']},

  {id:'darkacademia',emoji:'üìö',name:'Dark Academia',desc:'Books by candlelight',
   cls:'theme-darkacademia',grain:.28,
   vars:{accent:'#c8a870',bg:'#0a0806',text:'#e8dcc8','font-display':"'Cinzel',serif",'font-body':"'Spectral',serif",'font-accent':"'Caveat',cursive",'clock-tc':'#c8a870','clock-sub':'#e8dcc8','btn-border-radius':'2px','panel-radius':'8px'},
   bg:'background:radial-gradient(ellipse at 35% 15%,#2a1e10 0%,#0e0a06 50%,#060402 100%)',
   ov:'background:url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'80\'%3E%3Cline x1=\'0\' y1=\'0\' x2=\'80\' y2=\'80\' stroke=\'rgba(200,168,112,.035)\' stroke-width=\'.5\'/%3E%3Cline x1=\'80\' y1=\'0\' x2=\'0\' y2=\'80\' stroke=\'rgba(200,168,112,.035)\' stroke-width=\'.5\'/%3E%3C/svg%3E") repeat,radial-gradient(ellipse at 30% 110%,rgba(200,168,112,.18),transparent 50%)',
   glass:'background:rgba(18,12,6,.7);border:1px solid rgba(200,168,112,.28) !important',
   months:['Manuscripts','Ink & Quill','Dusk March','Forgotten April','Parchment May','Footnotes June','Thesis July','Archive August','Autumn Study','October Verses','Dim November','Winter Tomes']},

  {id:'cottagecore',emoji:'üåø',name:'Cottagecore',desc:'Field & hearth',
   cls:'',grain:.06,
   vars:{accent:'#6a8a50',bg:'#e8ead8',text:'#2c3820','font-display':"'Playfair Display',serif",'font-body':"'Nunito',sans-serif",'font-accent':"'Caveat',cursive",'clock-tc':'#2c3820','clock-sub':'#6a8a50','btn-border-radius':'50px','panel-radius':'20px'},
   bg:'background:linear-gradient(160deg,#e8ead8,#dcd8c0 35%,#d0ccb4 65%,#c8c4ac)',
   ov:'background-image:url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'80\'%3E%3Ccircle cx=\'20\' cy=\'20\' r=\'3\' fill=\'rgba(106,138,80,.1)\'/%3E%3Ccircle cx=\'60\' cy=\'60\' r=\'2\' fill=\'rgba(106,138,80,.08)\'/%3E%3C/svg%3E") repeat',
   glass:'background:rgba(224,220,200,.4)',
   months:['Root Cellar','Pressed Violets','First Bloom','Wildflower April','Meadow May','Berry Picking','Lavender July','Harvest Moon','Apple September','Mushroom Ring','Hearth November','Yule Log']},

  {id:'cleangirl',emoji:'ü´ß',name:'Clean Girl',desc:'Minimal glow',
   cls:'',grain:0,
   vars:{accent:'#9a8878',bg:'#fefcfa',text:'#2a2420','font-display':"'Cormorant Garamond',serif",'font-body':"'Raleway',sans-serif",'font-accent':"'Caveat',cursive",'clock-tc':'#2a2420','clock-sub':'#9a8878','btn-border-radius':'50px','panel-radius':'24px'},
   bg:'background:linear-gradient(160deg,#fefcfa,#f5f2ee 45%,#ede8e2 75%,#f0ece6)',
   ov:'background:radial-gradient(ellipse at 60% 20%,rgba(220,210,200,.5),transparent 60%)',
   glass:'background:rgba(255,252,248,.4)',
   months:['Bare January','Linen February','Clear March','Oat April','Calm May','Aura June','Dewy July','Bronze August','Neutral September','Still October','Cream November','Pure December']},

  {id:'indie',emoji:'üéµ',name:'Indie',desc:'Vinyl & neon haze',
   cls:'theme-indie',grain:.32,
   vars:{accent:'#e8a040',bg:'#0c0a06',text:'#e8d8c0','font-display':"'Abril Fatface',serif",'font-body':"'Nunito',sans-serif",'font-accent':"'Caveat',cursive",'clock-tc':'#e8a040','clock-sub':'#e8d8c0','btn-border-radius':'0px','panel-radius':'6px'},
   bg:'background:radial-gradient(ellipse at 25% 40%,#2a1a08 0%,#0c0a06 55%,#060402 100%)',
   ov:`background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300' viewBox='0 0 300 300'%3E%3Ccircle cx='150' cy='150' r='140' fill='none' stroke='rgba(232,160,64,.07)' stroke-width='1'/%3E%3Ccircle cx='150' cy='150' r='100' fill='none' stroke='rgba(232,160,64,.05)' stroke-width='1'/%3E%3Ccircle cx='150' cy='150' r='60' fill='none' stroke='rgba(232,160,64,.04)' stroke-width='1'/%3E%3Ccircle cx='150' cy='150' r='20' fill='none' stroke='rgba(232,160,64,.06)' stroke-width='2'/%3E%3Ccircle cx='150' cy='150' r='6' fill='rgba(232,160,64,.15)'/%3E%3C/svg%3E") center/300px`,
   glass:'background:rgba(16,12,6,.68);border:1px solid rgba(232,160,64,.25) !important',
   months:['B-Side January','Cover Art February','Demo March','Record Store April','Tour May','Festival June','Road Trip July','Studio August','Setlist September','Layover October','Deep Cut November','Outro December']},

  {id:'oldmoney',emoji:'üèõÔ∏è',name:'Old Money',desc:'Quiet luxury',
   cls:'',grain:.09,
   vars:{accent:'#6a5a3c',bg:'#e8e0c8',text:'#1e1810','font-display':"'GFS Didot',serif",'font-body':"'Josefin Sans',sans-serif",'font-accent':"'Sacramento',cursive",'clock-tc':'#1e1810','clock-sub':'#6a5a3c','btn-border-radius':'2px','panel-radius':'6px'},
   bg:'background:linear-gradient(155deg,#ede4cc 0%,#ddd4b0 40%,#d0c49c 70%,#c8bc90 100%)',
   ov:'background:url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\'%3E%3Cpath d=\'M0 20 L40 20 M20 0 L20 40\' stroke=\'rgba(106,90,60,.06)\' stroke-width=\'.5\'/%3E%3C/svg%3E") repeat',
   glass:'background:rgba(232,224,200,.52);border:1px solid rgba(106,90,60,.22) !important',
   months:['January Estate','Equestrian February','Hunt Season March','April in Tuscany','Monaco May','Riviera June','Hamptons July','Sailing August','Countryside September','Hunt Ball October','Velvet November','Christmas Manor']},

  {id:'balletcore',emoji:'ü©∞',name:'Balletcore',desc:'Tulle & arabesque',
   cls:'',grain:.05,
   vars:{accent:'#b06878',bg:'#fef0f4',text:'#3a1828','font-display':"'Cormorant Garamond',serif",'font-body':"'Josefin Sans',sans-serif",'font-accent':"'Sacramento',cursive",'clock-tc':'#3a1828','clock-sub':'#b06878','btn-border-radius':'50px','panel-radius':'28px'},
   bg:'background:linear-gradient(160deg,#fef2f6 0%,#f9dfe8 25%,#f5d5e2 55%,#f0ccd8 80%,#ead0d8 100%)',
   ov:'background:url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'160\' height=\'160\'%3E%3Cellipse cx=\'80\' cy=\'80\' rx=\'75\' ry=\'38\' fill=\'none\' stroke=\'rgba(176,104,120,.07)\' stroke-width=\'.8\'/%3E%3C/svg%3E") repeat',
   glass:'background:rgba(254,240,244,.5);border:1px solid rgba(176,104,120,.2) !important',
   months:['First Position','Pas de Deux','Arabesque March','Spring Recital','Pointe May','Summer Intensive','Adagio July','Corps August','Opening Night','Pirouette October','Reverence November','Nutcracker']},

  {id:'vanillagirl',emoji:'üç¶',name:'Vanilla Girl',desc:'Warm honey glow',
   cls:'',grain:.04,
   vars:{accent:'#b09050',bg:'#fef8e8',text:'#2a200a','font-display':"'Playfair Display',serif",'font-body':"'Nunito',sans-serif",'font-accent':"'Sacramento',cursive",'clock-tc':'#2a200a','clock-sub':'#b09050','btn-border-radius':'50px','panel-radius':'20px'},
   bg:'background:linear-gradient(160deg,#fef8e8 0%,#f9f0d0 30%,#f0e6c0 60%,#e8ddb0 100%)',
   ov:'background:radial-gradient(ellipse at 70% 25%,rgba(255,220,140,.6),transparent 50%)',
   glass:'background:rgba(254,245,220,.5)',
   months:['Warm January','Honey February','Satin March','Golden April','Oat Milk May','Sundress June','Warm Sand July','Sun Tea August','Cinnamon September','Apple Cider October','Caramel November','Vanilla December']},

  {id:'florals',emoji:'üå∏',name:'Florals',desc:'Jewel-toned garden',
   cls:'',grain:.06,
   vars:{accent:'#8a3868',bg:'#1a0818',text:'#f4e0f0','font-display':"'Crimson Pro',serif",'font-body':"'Raleway',sans-serif",'font-accent':"'Sacramento',cursive",'clock-tc':'#f0c8e0','clock-sub':'#d080a8','btn-border-radius':'50px','panel-radius':'18px'},
   bg:'background:radial-gradient(ellipse at 40% 30%,#3a1030 0%,#1a0818 50%,#0e0410 100%)',
   ov:'background:url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'120\' height=\'120\'%3E%3Ccircle cx=\'60\' cy=\'60\' r=\'22\' fill=\'none\' stroke=\'rgba(180,80,140,.12)\' stroke-width=\'1\'/%3E%3C/svg%3E") repeat',
   glass:'background:rgba(30,8,24,.65);border:1px solid rgba(180,80,140,.28) !important',
   months:['Snowdrop January','Paperwhite February','Cherry Blossom March','Tulip April','Peony May','Rose June','Sunflower July','Dahlia August','Chrysanthemum September','Marigold October','Hellebore November','Amaryllis December']},

  {id:'y2k',emoji:'üíø',name:'Y2K',desc:'Cyber pop shimmer',
   cls:'',grain:0,
   vars:{accent:'#9040c0',bg:'#f0d8ff',text:'#400060','font-display':"'Space Mono',monospace",'font-body':"'Raleway',sans-serif",'font-accent':"'Caveat',cursive",'clock-tc':'#400060','clock-sub':'#9040c0','btn-border-radius':'0px','panel-radius':'12px'},
   bg:'background:linear-gradient(135deg,#e8c8ff,#c0a0e8 25%,#f0d0ff 55%,#d0b0f0 80%,#e8c8ff)',
   ov:'background:url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\'%3E%3Ccircle cx=\'30\' cy=\'30\' r=\'28\' fill=\'none\' stroke=\'rgba(144,64,192,.12)\' stroke-width=\'.5\'/%3E%3C/svg%3E") repeat',
   glass:'background:rgba(224,184,255,.35)',
   months:['BOOT_JAN','FEB.exe','MARCH.zip','APRIL.mp3','MAY.gif','JUNE.swf','JULY.bmp','AUG.wav','SEP.html','OCT.css','NOV.js','DEC.dll']},

  {id:'barbiecore',emoji:'üíñ',name:'Barbiecore',desc:'Pink everything',
   cls:'',grain:0,
   vars:{accent:'#e0008a',bg:'#ff80c0',text:'#600040','font-display':"'Playfair Display',serif",'font-body':"'Raleway',sans-serif",'font-accent':"'Sacramento',cursive",'clock-tc':'#600040','clock-sub':'#e0008a','btn-border-radius':'50px','panel-radius':'24px'},
   bg:'background:linear-gradient(160deg,#ff80c0,#ff60a8 22%,#ff80c8 48%,#ff90d0 72%,#ffb0e0)',
   ov:'background-image:radial-gradient(circle at 30% 40%,rgba(255,255,255,.32),transparent 40%)',
   glass:'background:rgba(255,176,216,.35)',
   months:['Dream January','Valentine Glam','Pink March','Blossom April','Hot Pink May','Glitter June','Malibu July','Barbie Summer','Sparkle September','Pink October','Fuchsia November','Dream December']},

  {id:'forestcore',emoji:'üå≤',name:'Forestcore',desc:'Ancient mossy dark',
   cls:'theme-forestcore',grain:.38,
   vars:{accent:'#88b058',bg:'#060e04',text:'#c8e0a8','font-display':"'Spectral',serif",'font-body':"'Nunito',sans-serif",'font-accent':"'Caveat',cursive",'clock-tc':'#a8c078','clock-sub':'#c8e0a8','btn-border-radius':'4px','panel-radius':'8px'},
   bg:'background:radial-gradient(ellipse at 50% 0%,#1e3014 0%,#0e1a0a 45%,#060e04 100%)',
   ov:'background:url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'160\' height=\'160\'%3E%3Cpath d=\'M80 10 L70 50 L80 42 L90 50Z\' fill=\'rgba(136,176,88,.07)\'/%3E%3C/svg%3E") repeat',
   glass:'background:rgba(8,18,6,.7);border:1px solid rgba(136,176,88,.25) !important',
   months:['Frost & Fern','Bare Birch','Moss March','Wildwood April','Lichen May','Canopy June','Dappled July','Ancient August','Ember Leaves','Mushroom Ring','First Snow','Winter Pines']},

  {id:'preppy',emoji:'‚öì',name:'Preppy',desc:'Varsity chic',
   cls:'',grain:0,
   vars:{accent:'#c84040',bg:'#e8eeff',text:'#0a1a50','font-display':"'Libre Baskerville',serif",'font-body':"'Raleway',sans-serif",'font-accent':"'Caveat',cursive",'clock-tc':'#0a1a50','clock-sub':'#c84040','btn-border-radius':'4px','panel-radius':'12px'},
   bg:'background:linear-gradient(160deg,#e8eeff,#d0d8ff 32%,#c8d4ff 62%,#d8e4ff)',
   ov:'background:url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'20\' height=\'20\'%3E%3Crect x=\'0\' y=\'0\' width=\'10\' height=\'10\' fill=\'rgba(200,64,64,.05)\'/%3E%3Crect x=\'10\' y=\'10\' width=\'10\' height=\'10\' fill=\'rgba(200,64,64,.05)\'/%3E%3C/svg%3E") repeat',
   glass:'background:rgba(216,228,255,.4)',
   months:['New Semester','Valentines','Spring Break','Easter Weekend','Regatta May','Tennis June','Lake July','Lacrosse August','Back To School','Homecoming','Thanksgiving','Winter Ball']},

  /* ‚ïê‚ïê‚ïê‚ïê CHEETAH ‚Äî wild amber & obsidian, animalistic, high-contrast, aggressive spots ‚ïê‚ïê‚ïê‚ïê */
  {id:'cheetah',emoji:'üêÜ',name:'Cheetah',desc:'Wild & untamed',
   cls:'theme-cheetah',grain:.42,
   vars:{
     accent:'#dca830',
     bg:'#0c0804',
     text:'#f0e0a0',
     'font-display':"'Barlow Condensed',sans-serif",
     'font-body':"'Barlow Condensed',sans-serif",
     'font-accent':"'Caveat',cursive",
     'clock-tc':'#f0d070',
     'clock-sub':'#dca830',
     'btn-border-radius':'3px',
     'panel-radius':'6px'
   },
   bg:'background:radial-gradient(ellipse at 30% 20%,#2a1c06 0%,#140e02 45%,#0c0804 100%)',
   ov:`background:
     url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220' viewBox='0 0 220 220'%3E%3Cellipse cx='40' cy='35' rx='11' ry='7' fill='rgba(20,12,2,.55)' transform='rotate(-20,40,35)'/%3E%3Cellipse cx='80' cy='18' rx='8' ry='5' fill='rgba(20,12,2,.45)' transform='rotate(10,80,18)'/%3E%3Cellipse cx='130' cy='50' rx='13' ry='8' fill='rgba(20,12,2,.5)' transform='rotate(25,130,50)'/%3E%3Cellipse cx='175' cy='22' rx='9' ry='6' fill='rgba(20,12,2,.4)' transform='rotate(-15,175,22)'/%3E%3Cellipse cx='200' cy='80' rx='11' ry='7' fill='rgba(20,12,2,.5)' transform='rotate(30,200,80)'/%3E%3Cellipse cx='55' cy='100' rx='10' ry='6' fill='rgba(20,12,2,.48)' transform='rotate(-10,55,100)'/%3E%3Cellipse cx='105' cy='120' rx='14' ry='8' fill='rgba(20,12,2,.52)' transform='rotate(15,105,120)'/%3E%3Cellipse cx='160' cy='145' rx='10' ry='6' fill='rgba(20,12,2,.45)' transform='rotate(-25,160,145)'/%3E%3Cellipse cx='25' cy='175' rx='12' ry='7' fill='rgba(20,12,2,.5)' transform='rotate(20,25,175)'/%3E%3Cellipse cx='85' cy='195' rx='9' ry='5' fill='rgba(20,12,2,.42)' transform='rotate(-5,85,195)'/%3E%3Cellipse cx='140' cy='200' rx='13' ry='8' fill='rgba(20,12,2,.5)' transform='rotate(18,140,200)'/%3E%3Cellipse cx='195' cy='170' rx='10' ry='6' fill='rgba(20,12,2,.47)' transform='rotate(-30,195,170)'/%3E%3C/svg%3E") repeat,
     radial-gradient(ellipse at 70% 15%,rgba(220,168,48,.12),transparent 45%),
     radial-gradient(ellipse at 15% 85%,rgba(180,100,20,.1),transparent 40%)`,
   glass:'background:rgba(18,12,4,.75);border:1px solid rgba(220,168,48,.32) !important;box-shadow:0 0 0 1px rgba(220,168,48,.08),0 22px 64px rgba(0,0,0,.5) !important',
   months:['Dry Season','Territory March','Prowl','Spring Hunt','Savanna May','Dust Season','High Heat','Peak Chase','Amber Dusk','Migration','Bare Ground','Cold Stalk']},
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STORAGE & STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const MN=["January","February","March","April","May","June","July","August","September","October","November","December"];
const PALETTE=["#4a8fa8","#d4708a","#6a8a50","#c8a060","#9040c0","#e0008a","#c84040","#2050a0","#e8a040","#5a7a4a","#c8820a","#a04878"];
function safeGet(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch{return d;}}
function safeSave(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch{}}

let theme=safeGet("cal-theme","coastal");
let events=safeGet("cal-events",[]);
let notes=safeGet("cal-notes",[]);
let moods=safeGet("cal-moods",{});
let dayPhotos=safeGet("cal-photos",{});
let userName=safeGet("cal-username","");
let calendars=safeGet("cal-calendars",[
  {id:"personal",name:"Personal",type:"personal",color:"#4a8fa8",visible:true},
  {id:"combined-default",name:"Combined",type:"combined",color:"#c8820a",visible:true,
   inviteCode:"COMB-"+(Math.random().toString(36).substr(2,4).toUpperCase()),members:[]},
]);

let viewDate=new Date(),activeCalId="all",selColor=PALETTE[0],selCalColor=PALETTE[0],selCalType="personal";
let curPanel=null,curScreen="name-setup",isCalOpen=false,use24h=false,curDayStr=null;
let idleTimer,idleBarIv,idleP=0;const IDLE_MS=22000;
let ncColor=PALETTE[2];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SCREENS ‚Äî multi-screen navigation
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SCREENS=["name-setup-screen","clock-screen","calendar-screen","combined-screen"];
function showScreen(id){
  SCREENS.forEach(s=>{
    const el=document.getElementById(s);
    if(el){el.classList.remove("visible");el.classList.add("hidden");}
  });
  const target=document.getElementById(id);
  if(target){target.classList.remove("hidden");target.classList.add("visible");}
  curScreen=id;
  if(id==="combined-screen"){renderCombinedCalendar();isCalOpen=false;}
  else if(id==="calendar-screen"){isCalOpen=true;resetIdleBar();}
  else if(id==="clock-screen"){isCalOpen=false;renderIdleEvents();}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NAME SETUP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initNameSetup(){
  // Check URL for auto-join invite code first
  const urlCode=getUrlJoinCode();
  if(urlCode){
    // Show setup with a note about joining
    document.querySelector(".ns-subtitle").textContent="Enter your name to join the calendar";
  }
  if(userName){
    // Name already set ‚Äî skip to clock
    startApp(urlCode);
  } else {
    showScreen("name-setup-screen");
  }
}

function getUrlJoinCode(){
  const params=new URLSearchParams(location.search);
  return params.get("join")||null;
}

function startApp(autoJoinCode){
  updateUserUI();
  applyTheme(theme);
  // Auto-join if code in URL
  if(autoJoinCode){
    const joined=attemptJoin(autoJoinCode.toUpperCase());
    if(joined) setTimeout(()=>{showScreen("combined-screen");toast("Joined \""+joined+"\" ‚ú¶");burst(document.getElementById("cs-join-btn"));},600);
    else setTimeout(()=>{showScreen("clock-screen");toast("Invite code not found ‚ú¶");},600);
    // Clean URL
    history.replaceState({},"",location.pathname);
  } else {
    showScreen("clock-screen");
  }
}

document.getElementById("ns-confirm-btn").addEventListener("click",()=>{
  const name=document.getElementById("ns-name-input").value.trim();
  if(name){userName=name;safeSave("cal-username",userName);}
  startApp(getUrlJoinCode());
  if(getUrlJoinCode())history.replaceState({},"",location.pathname);
});
document.getElementById("ns-skip-btn").addEventListener("click",()=>{
  startApp(getUrlJoinCode());
  if(getUrlJoinCode())history.replaceState({},"",location.pathname);
});
document.getElementById("ns-name-input").addEventListener("keydown",e=>{if(e.key==="Enter")document.getElementById("ns-confirm-btn").click();});

function updateUserUI(){
  const n=userName||"Anonymous";
  const initial=n.charAt(0).toUpperCase()||"?";
  // identity strip (top of combined screen)
  const av=document.getElementById("cs-avatar");if(av)av.textContent=initial;
  const nd=document.getElementById("cs-name-display");if(nd)nd.textContent=n;
  const sn=document.getElementById("cs-signed-name");if(sn)sn.textContent=n;
  // drawer user bar
  const av2=document.getElementById("cs-avatar-lg");if(av2)av2.textContent=initial;
  const nm2=document.getElementById("cs-name-main");if(nm2)nm2.textContent=n;
  updateClockMood();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NAME EDIT POPUP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.getElementById("cs-name-edit-btn").addEventListener("click",()=>{
  document.getElementById("name-edit-input").value=userName||"";
  showP("name-edit-panel");
});
document.getElementById("close-name-edit").addEventListener("click",()=>closeP("name-edit-panel"));
document.getElementById("btn-save-name-edit").addEventListener("click",()=>{
  const name=document.getElementById("name-edit-input").value.trim();
  userName=name;safeSave("cal-username",userName);updateUserUI();
  closeP("name-edit-panel");toast("Name updated to \""+name+"\" ‚ú¶");renderCombinedScreen();
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CURSOR
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const cRing=document.getElementById("cursor"),cDot=document.getElementById("cursor-dot");
let mx=400,my=300,cx2=400,cy2=300;
document.addEventListener("mousemove",e=>{mx=e.clientX;my=e.clientY;cDot.style.left=mx+"px";cDot.style.top=my+"px";onActivity();});
document.addEventListener("touchmove",e=>{mx=e.touches[0].clientX;my=e.touches[0].clientY;onActivity();},{passive:true});
document.addEventListener("touchstart",()=>onActivity(),{passive:true});
document.addEventListener("mouseover",e=>{cRing.classList.toggle("big",!!e.target.closest("button,.cal-day,.t-card,.c-swatch,.section-tab,.mood-btn,.mood-grid-btn,.cs-cal-card,.cs-new-cal-wrap"));});
(function ac(){cx2+=(mx-cx2)*.18;cy2+=(my-cy2)*.18;cRing.style.left=cx2+"px";cRing.style.top=cy2+"px";requestAnimationFrame(ac);})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   APPLY THEME
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function applyTheme(id){
  theme=id;safeSave("cal-theme",theme);
  const td=THEMES.find(t=>t.id===id)||THEMES[0];
  const root=document.documentElement;
  Object.entries(td.vars).forEach(([k,v])=>root.style.setProperty("--"+k,v));
  root.style.setProperty("--bg",td.vars.bg||"#eaf4fb");
  document.body.style.color=td.vars.text||"#1a3d52";
  root.style.setProperty("--theme-grain",td.grain||0);
  const bgEl=document.getElementById("theme-bg-el");
  bgEl.style.cssText=td.bg+";position:fixed;inset:0;z-index:-1;transition:all 1.2s";
  const ovEl=document.getElementById("theme-overlay-el");
  ovEl.innerHTML="";
  ovEl.style.cssText=td.ov+";position:fixed;inset:0;z-index:0;pointer-events:none;transition:all 1.2s";
  const gl=document.getElementById("clock-glass");
  if(gl)gl.style.cssText=td.glass+";backdrop-filter:blur(22px);-webkit-backdrop-filter:blur(22px);border:1px solid rgba(255,255,255,.2);border-radius:28px;padding:32px 48px 24px;box-shadow:0 22px 64px rgba(0,0,0,.2);transition:background .9s,border-color .9s";
  document.body.className="";
  if(td.cls)document.body.classList.add(td.cls);
  cRing.style.borderColor=td.vars.accent||"#4a8fa8";
  cDot.style.background=td.vars.accent||"#4a8fa8";
  updateClockTag();renderCalendar();renderCalSections();renderIdleEvents();updateClockMood();
  document.querySelectorAll(".t-card").forEach(c=>c.classList.toggle("active",c.dataset.id===id));
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CLOCK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function fmtTime(t){
  if(!t)return"";const[h,m]=t.split(":").map(Number);
  if(use24h)return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
  return(h%12||12)+":"+String(m).padStart(2,"0")+(h<12?" AM":" PM");
}
function updateClock(){
  const n=new Date();const h=n.getHours(),m=String(n.getMinutes()).padStart(2,"0");
  document.getElementById("clock-time").textContent=use24h?String(h).padStart(2,"0")+":"+m:(h%12||12)+":"+m;
  const DAYS=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
  document.getElementById("clock-date").textContent=DAYS[n.getDay()]+" ¬∑ "+MN[n.getMonth()]+" "+n.getDate()+", "+n.getFullYear();
}
updateClock();setInterval(updateClock,1000);
document.getElementById("btn-time-toggle").addEventListener("click",()=>{
  use24h=!use24h;document.getElementById("btn-time-toggle").textContent=use24h?"24h":"12h";
  updateClock();renderCalendar();renderIdleEvents();
});
function updateClockTag(){const td=THEMES.find(t=>t.id===theme)||THEMES[0];const n=new Date();document.getElementById("clock-theme-tag").textContent=td.emoji+"  "+td.months[n.getMonth()];}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOOD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateClockMood(){
  const today=todayStr();const mi=moods[today];
  const disp=document.getElementById("clock-mood-display");
  const lbl=document.getElementById("clock-mood-label");
  if(mi!=null&&MOODS[mi]){disp.textContent=MOODS[mi].e;lbl.textContent=MOODS[mi].l;}
  else{disp.textContent="‚òÄÔ∏è";lbl.textContent="";}
}
document.getElementById("clock-mood-display").addEventListener("click",()=>openMoodPopup(todayStr()));
function openMoodPopup(dateStr){
  const d=new Date(dateStr+"T12:00:00");
  document.getElementById("mood-date-label").textContent=MN[d.getMonth()]+" "+d.getDate()+", "+d.getFullYear();
  const grid=document.getElementById("mood-popup-grid");grid.innerHTML="";
  const sel=moods[dateStr];
  MOODS.forEach((m,i)=>{
    const btn=document.createElement("button");btn.className="mood-grid-btn"+(sel===i?" sel":"");
    btn.innerHTML=`<span class="me">${m.e}</span><span class="ml">${m.l}</span>`;
    btn.addEventListener("click",()=>{
      moods[dateStr]=i;safeSave("cal-moods",moods);
      grid.querySelectorAll(".mood-grid-btn").forEach((b,j)=>b.classList.toggle("sel",j===i));
      updateClockMood();renderCalendar();
      if(curDayStr===dateStr)buildMoodInPanel(dateStr);
      setTimeout(()=>closeP("mood-popup"),400);toast(m.e+" "+m.l+" ‚ú¶");
    });
    grid.appendChild(btn);
  });
  document.getElementById("mood-popup-clear").onclick=()=>{
    delete moods[dateStr];safeSave("cal-moods",moods);
    openMoodPopup(dateStr);updateClockMood();renderCalendar();
    if(curDayStr===dateStr)buildMoodInPanel(dateStr);
  };
  showP("mood-popup");
}
document.getElementById("close-mood").addEventListener("click",()=>closeP("mood-popup"));

function buildMoodInPanel(dateStr){
  const wrap=document.getElementById("dp-mood-emojis");wrap.innerHTML="";
  const sel=moods[dateStr];
  MOODS.forEach((m,i)=>{
    const btn=document.createElement("button");btn.className="mood-btn"+(sel===i?" sel":"");
    btn.title=m.l;btn.textContent=m.e;
    btn.addEventListener("click",()=>{
      moods[dateStr]=i;safeSave("cal-moods",moods);
      wrap.querySelectorAll(".mood-btn").forEach((b,j)=>b.classList.toggle("sel",j===i));
      updateClockMood();renderCalendar();
    });
    wrap.appendChild(btn);
  });
  document.getElementById("dp-mood-clear").onclick=()=>{
    delete moods[dateStr];safeSave("cal-moods",moods);
    buildMoodInPanel(dateStr);updateClockMood();renderCalendar();
  };
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   IDLE EVENTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderIdleEvents(){
  const today=todayStr();const now=new Date();
  const todayEvs=events.filter(e=>e.date===today).sort((a,b)=>(a.time||"99:99").localeCompare(b.time||"99:99"));
  const hols=getHolsForDate(now.getFullYear(),now.getMonth(),now.getDate());
  const list=document.getElementById("idle-ev-list");list.innerHTML="";
  const dark=["grunge","darkacademia","forestcore","indie","cheetah","florals"].includes(theme);
  hols.forEach(h=>{
    const item=document.createElement("div");item.className="idle-ev-item";
    item.style.background=dark?"rgba(255,215,0,.08)":"rgba(255,215,0,.14)";item.style.borderColor="rgba(255,215,0,.35)";
    item.innerHTML=`<div class="idle-ev-dot" style="background:#e8b000"></div><div class="idle-ev-text"><div class="idle-ev-name" style="color:var(--clock-tc)">${h[2]}</div></div><div class="idle-ev-cal" style="background:rgba(255,215,0,.18);color:#8a6000">${h[3]} Holiday</div>`;
    list.appendChild(item);
  });
  todayEvs.forEach(ev=>{
    const cal=calendars.find(c=>c.id===(ev.calId||"personal"));
    const col=ev.color||(cal?cal.color:"var(--accent)");
    const icon={personal:"üë§",combined:"üîó"}[cal?.type]||"üìÖ";
    const item=document.createElement("div");item.className="idle-ev-item";
    item.style.background=dark?"rgba(255,255,255,.07)":"rgba(0,0,0,.04)";item.style.borderColor=dark?"rgba(255,255,255,.1)":"rgba(0,0,0,.07)";
    item.innerHTML=`<div class="idle-ev-dot" style="background:${col}"></div><div class="idle-ev-text"><div class="idle-ev-name" style="color:var(--clock-tc)">${esc(ev.title)}${ev.nameLabel?'<span style="opacity:.55;font-size:.7em;margin-left:5px">['+esc(ev.nameLabel)+"]</span>":""}</div>${ev.time?'<div class="idle-ev-time">'+fmtTime(ev.time)+"</div>":""}</div><div class="idle-ev-cal" style="background:${col}20;color:${col}">${icon} ${esc(cal?.name||"Personal")}</div>`;
    list.appendChild(item);
  });
  if(!todayEvs.length&&!hols.length)list.innerHTML='<div class="idle-no-events">Nothing today ‚ú¶</div>';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   IDLE BAR & ACTIVITY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const idleBarEl=document.getElementById("idle-bar");
function resetIdleBar(){idleP=0;idleBarEl.style.width="0%";clearInterval(idleBarIv);if(!isCalOpen)return;idleBarIv=setInterval(()=>{idleP+=100/(IDLE_MS/150);idleBarEl.style.width=Math.min(idleP,100)+"%";if(idleP>=100)clearInterval(idleBarIv);},150);}
function onActivity(){
  clearTimeout(idleTimer);
  if(curScreen==="clock-screen"){showScreen("calendar-screen");isCalOpen=true;resetIdleBar();}
  else if(curScreen==="calendar-screen"){resetIdleBar();}
  if(curScreen!=="name-setup-screen"){
    idleTimer=setTimeout(()=>{if(!curPanel&&curScreen==="calendar-screen"){showScreen("clock-screen");isCalOpen=false;}},IDLE_MS);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CALENDAR RENDER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderCalendar(){
  const td=THEMES.find(t=>t.id===theme)||THEMES[0];
  const mo=viewDate.getMonth(),yr=viewDate.getFullYear();
  document.getElementById("cal-month").textContent=MN[mo];
  document.getElementById("cal-year").textContent=yr;
  document.getElementById("month-banner").textContent="‚ú¶  "+td.months[mo]+"  ‚ú¶";
  const firstWD=new Date(yr,mo,1).getDay(),dim=new Date(yr,mo+1,0).getDate(),dimPrev=new Date(yr,mo,0).getDate(),today=new Date();
  const visIds=getVisCalIds();
  const container=document.getElementById("cal-days");container.innerHTML="";
  const total=Math.ceil((firstWD+dim)/7)*7;
  for(let i=0;i<total;i++){
    let day,cur=true,cMo=mo,cYr=yr;
    if(i<firstWD){day=dimPrev-firstWD+i+1;cur=false;cMo=mo-1;if(cMo<0){cMo=11;cYr=yr-1;}}
    else if(i>=firstWD+dim){day=i-firstWD-dim+1;cur=false;cMo=mo+1;if(cMo>11){cMo=0;cYr=yr+1;}}
    else day=i-firstWD+1;
    const ds=cYr+"-"+String(cMo+1).padStart(2,"0")+"-"+String(day).padStart(2,"0");
    const isToday=cur&&day===today.getDate()&&mo===today.getMonth()&&yr===today.getFullYear();
    const dayEvs=events.filter(e=>e.date===ds&&visIds.includes(e.calId||"personal"));
    const dayHols=cur?getHolsForDate(cYr,cMo,day):[];
    const dayMood=moods[ds];
    const hasPhoto=!!dayPhotos[ds];
    const hasContent=dayEvs.length>0||dayHols.length>0;
    const cell=document.createElement("div");
    cell.className="cal-day"+(isToday?" today":"")+(!cur?" other-month":"")+(hasPhoto?" has-photo":"");
    cell.dataset.date=ds;
    const num=document.createElement("div");num.className="d-num";num.textContent=day;cell.appendChild(num);
    if(dayMood!=null&&MOODS[dayMood]){const md=document.createElement("div");md.className="d-mood";md.textContent=MOODS[dayMood].e;md.title=MOODS[dayMood].l;cell.appendChild(md);}
    if(dayHols.length){const hb=document.createElement("div");hb.className="d-holiday-badge"+(dayMood!=null?" d-has-mood":"");hb.textContent=dayHols[0][3];hb.title=dayHols[0][2];cell.appendChild(hb);}
    if(hasContent){
      const dots=document.createElement("div");dots.className="d-dots";
      dayHols.forEach(h=>{const d=document.createElement("div");d.className="d-dot";d.style.background="rgba(220,180,0,.8)";d.style.border="1.5px solid rgba(255,215,0,.7)";d.title=h[2];dots.appendChild(d);});
      dayEvs.forEach(ev=>{
        const cal=calendars.find(c=>c.id===(ev.calId||"personal"));
        const col=ev.color||(cal?cal.color:"var(--accent)");
        const d=document.createElement("div");d.className="d-dot";d.style.background=col;d.title=ev.title+(ev.nameLabel?` [${ev.nameLabel}]`:"");
        dots.appendChild(d);
      });
      cell.appendChild(dots);
      const labels=document.createElement("div");labels.className="d-labels";
      const allItems=[...dayHols.map(h=>({isH:true,...h})),...dayEvs];
      allItems.slice(0,2).forEach(item=>{
        const chip=document.createElement("div");
        if(item.isH){chip.className="ev-chip holiday-chip";chip.textContent=item[3]+" "+item[2];}
        else{
          const cal=calendars.find(c=>c.id===(item.calId||"personal"));
          chip.className="ev-chip"+(cal?.type==="combined"?" combined-tag":"");
          chip.style.background=item.color||(cal?cal.color:"var(--accent)");
          chip.textContent=item.title+(item.nameLabel?" ["+item.nameLabel+"]":"");
        }
        labels.appendChild(chip);
      });
      if(allItems.length>2){const more=document.createElement("div");more.className="ev-more";more.textContent="+"+(allItems.length-2)+" more";labels.appendChild(more);}
      cell.appendChild(labels);
    }
    cell.addEventListener("mouseenter",ev=>showTip(ev,ds,dayEvs,dayHols,dayMood));
    cell.addEventListener("mouseleave",startHideTip);
    cell.addEventListener("click",()=>{hideTooltip();openDayPanel(ds);});
    container.appendChild(cell);
  }
}
function getVisCalIds(){
  const personal=calendars.filter(c=>c.type==="personal"&&c.visible).map(c=>c.id);
  if(activeCalId==="all")return [...personal];
  return[activeCalId];
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CAL SECTIONS (personal only on main calendar)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderCalSections(){
  const personal=calendars.filter(c=>c.type==="personal");
  const wrap=document.getElementById("personal-tabs");wrap.innerHTML="";
  const all=document.createElement("button");all.className="section-tab"+(activeCalId==="all"?" active":"");
  all.innerHTML='<span class="section-tab-dot" style="background:var(--accent)"></span>All';
  all.addEventListener("click",()=>{activeCalId="all";renderCalSections();renderCalendar();});wrap.appendChild(all);
  personal.forEach(cal=>{
    const tab=document.createElement("button");tab.className="section-tab"+(activeCalId===cal.id?" active":"");tab.style.opacity=cal.visible?"1":"0.44";
    tab.innerHTML=`<span class="section-tab-dot" style="background:${cal.color}"></span>üë§ ${esc(cal.name)}`;
    tab.addEventListener("click",()=>{activeCalId=cal.id;renderCalSections();renderCalendar();});wrap.appendChild(tab);
  });
  const add=document.createElement("button");add.className="add-cal-inline";add.textContent="+ Add";
  add.addEventListener("click",()=>{renderCalList();showP("manage-cals-panel");});wrap.appendChild(add);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TOOLTIP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const tipEl=document.getElementById("tooltip");let tipTm;
function showTip(ev,ds,dayEvs,dayHols,dayMood){
  clearTimeout(tipTm);
  const d=new Date(ds+"T12:00:00");
  let html=`<div class="tt-date">${MN[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}</div>`;
  if(dayMood!=null&&MOODS[dayMood])html+=`<div class="tt-mood">${MOODS[dayMood].e} <span style="opacity:.65">${MOODS[dayMood].l}</span></div>`;
  dayHols.forEach(h=>html+=`<div class="tt-holiday-row">${h[3]} <strong>${esc(h[2])}</strong></div>`);
  if(!dayEvs.length&&!dayHols.length)html+='<div class="tt-empty">Click to open ‚ú¶</div>';
  dayEvs.forEach(e=>{
    const cal=calendars.find(c=>c.id===(e.calId||"personal"));
    const col=e.color||(cal?cal.color:"var(--accent)");
    html+=`<div class="tt-ev" style="border-color:${col}"><div class="tt-ev-main"><strong>${esc(e.title)}</strong>${e.nameLabel?'<span style="opacity:.5;font-size:.85em"> ['+esc(e.nameLabel)+']</span>':""}${e.time?" ¬∑ "+fmtTime(e.time):''}<div class="tt-cal-tag">${esc(cal?.name||"Personal")}</div></div><button class="tt-del" data-id="${e.id}">‚úï</button></div>`;
  });
  tipEl.innerHTML=html;
  tipEl.querySelectorAll(".tt-del").forEach(btn=>btn.addEventListener("click",e=>{e.stopPropagation();deleteEvent(Number(btn.dataset.id));hideTooltip();}));
  const r=ev.currentTarget.getBoundingClientRect();let L=r.right+10,T=r.top;
  if(L+252>window.innerWidth)L=r.left-258;if(T+280>window.innerHeight)T=window.innerHeight-283;
  tipEl.style.left=Math.max(4,L)+"px";tipEl.style.top=Math.max(4,T)+"px";tipEl.classList.add("show");
}
function startHideTip(){tipTm=setTimeout(hideTooltip,380);}
function hideTooltip(){tipEl.classList.remove("show");}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DAY DETAIL PANEL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openDayPanel(ds){
  curDayStr=ds;
  const d=new Date(ds+"T12:00:00");
  document.getElementById("dp-date-title").textContent=MN[d.getMonth()]+" "+d.getDate()+", "+d.getFullYear();
  const img=document.getElementById("dp-photo-img");
  const placeholder=document.getElementById("dp-photo-placeholder");
  const changeBtn=document.getElementById("dp-photo-change");
  const photo=dayPhotos[ds];
  if(photo){img.src=photo;img.classList.add("loaded");placeholder.style.display="none";changeBtn.style.display="block";}
  else{img.src="";img.classList.remove("loaded");placeholder.style.display="flex";changeBtn.style.display="none";}
  buildMoodInPanel(ds);
  const holsContainer=document.getElementById("dp-holidays");holsContainer.innerHTML="";
  const hols=getHolsForDate(d.getFullYear(),d.getMonth(),d.getDate());
  if(hols.length){hols.forEach(h=>{const el=document.createElement("div");el.className="dp-holiday-item";el.innerHTML=`<div class="dp-holiday-icon">${h[3]}</div><div class="dp-holiday-name">${h[2]}</div>`;holsContainer.appendChild(el);});}
  else{holsContainer.innerHTML='<p style="font-family:var(--font-body);font-size:.7rem;opacity:.32;padding:4px 0;font-style:italic">No holidays</p>';}
  renderDayPanelEvents(ds);
  document.getElementById("dp-quick-add").onclick=()=>{closeP("day-panel");openAddPanel(ds);};
  showP("day-panel");
}
function renderDayPanelEvents(ds){
  const dayEvs=events.filter(e=>e.date===ds).sort((a,b)=>(a.time||"99:99").localeCompare(b.time||"99:99"));
  const list=document.getElementById("dp-ev-list");list.innerHTML="";
  if(!dayEvs.length){list.innerHTML='<p style="font-family:var(--font-body);font-size:.7rem;opacity:.3;padding:4px 0;font-style:italic;text-align:center">No events ‚Äî add one ‚ú¶</p>';return;}
  dayEvs.forEach(ev=>{
    const cal=calendars.find(c=>c.id===(ev.calId||"personal"));
    const col=ev.color||(cal?cal.color:"var(--accent)");
    const isCombined=cal?.type==="combined";
    const item=document.createElement("div");item.className="dp-ev-item"+(isCombined?" combined-event":"");
    if(isCombined)item.style.borderLeftColor=col;
    item.innerHTML=`<div class="dp-ev-dot" style="background:${col}"></div><div class="dp-ev-info"><div class="dp-ev-name">${esc(ev.title)}${ev.nameLabel?'<span style="opacity:.55;font-size:.8em;margin-left:5px">['+esc(ev.nameLabel)+']</span>':''}${ev.nameLabel&&ev.nameLabel===(userName||"")?' <span style="opacity:.5;font-size:.7em">(you)</span>':''}</div><div class="dp-ev-meta">${ev.time?fmtTime(ev.time)+" ¬∑ ":""}${esc(cal?.name||"Personal")}</div></div><button class="dp-ev-del" title="Remove event">‚úï</button>`;
    item.querySelector(".dp-ev-del").addEventListener("click",e=>{e.stopPropagation();deleteEvent(ev.id);renderDayPanelEvents(ds);renderCalendar();});
    list.appendChild(item);
  });
}
document.getElementById("dp-photo-placeholder").addEventListener("click",()=>document.getElementById("dp-photo-input").click());
document.getElementById("dp-photo-change").addEventListener("click",()=>document.getElementById("dp-photo-input").click());
document.getElementById("dp-photo-input").addEventListener("change",e=>{
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    dayPhotos[curDayStr]=ev.target.result;safeSave("cal-photos",dayPhotos);
    const img=document.getElementById("dp-photo-img");img.src=ev.target.result;img.classList.add("loaded");
    document.getElementById("dp-photo-placeholder").style.display="none";
    document.getElementById("dp-photo-change").style.display="block";
    renderCalendar();toast("Photo saved ‚ú¶");
  };
  reader.readAsDataURL(file);e.target.value="";
});
document.getElementById("close-day").addEventListener("click",()=>closeP("day-panel"));
function deleteEvent(id){
  events=events.filter(e=>e.id!==id);safeSave("cal-events",events);renderCalendar();renderIdleEvents();toast("Event removed ‚ú¶");
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ADD EVENT ‚Äî name auto-filled from userName
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildCalSelect(preferCombined){
  const sel=document.getElementById("ev-cal-select");sel.innerHTML="";
  calendars.forEach(cal=>{
    const opt=document.createElement("option");opt.value=cal.id;
    const icon=cal.type==="personal"?"üë§":"üîó";
    opt.textContent=icon+" "+cal.name;
    if(preferCombined&&cal.type==="combined")opt.selected=true;
    sel.appendChild(opt);
  });
  updateCalSelectUI();
}
function updateCalSelectUI(){
  const sel=document.getElementById("ev-cal-select");
  const calId=sel.value;
  const cal=calendars.find(c=>c.id===calId);
  // Show name hint if combined
  const hint=document.getElementById("ev-name-hint");
  if(hint)hint.style.display=cal?.type==="combined"?"block":"none";
}
document.getElementById("btn-add").addEventListener("click",()=>openAddPanel(todayStr(),false));
document.getElementById("close-add").addEventListener("click",()=>closeP("add-event-panel"));
document.getElementById("btn-save-ev").addEventListener("click",saveEvent);
document.getElementById("ev-cal-select").addEventListener("change",updateCalSelectUI);

function openAddPanel(ds,preferCombined){
  buildCalSelect(preferCombined);
  document.getElementById("ev-title").value="";
  document.getElementById("ev-date").value=ds||todayStr();
  document.getElementById("ev-time").value="";
  document.getElementById("ev-note").value="";
  selColor=PALETTE[0];
  document.getElementById("color-row").querySelectorAll(".c-swatch").forEach((s,i)=>s.classList.toggle("sel",i===0));
  updateCalSelectUI();
  showP("add-event-panel");
}

function saveEvent(){
  const title=document.getElementById("ev-title").value.trim();
  const date=document.getElementById("ev-date").value;
  if(!title){toast("Please enter a title ‚ú¶");return;}
  if(!date){toast("Please pick a date ‚ú¶");return;}
  const calId=document.getElementById("ev-cal-select").value;
  const cal=calendars.find(c=>c.id===calId);
  const isCombined=cal?.type==="combined";
  // Auto-use stored userName for combined events
  const nameLabel=isCombined?(userName||""): "";
  events.push({id:Date.now(),title,date,time:document.getElementById("ev-time").value,nameLabel,note:document.getElementById("ev-note").value.trim(),color:selColor,calId});
  safeSave("cal-events",events);renderCalendar();renderIdleEvents();
  if(curScreen==="combined-screen")renderCombinedCalendar();
  closeP("add-event-panel");
  toast("Event saved ‚ú¶");burst(document.getElementById("btn-save-ev"));
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COMBINED SCREEN ‚Äî full separate calendar
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let csViewDate=new Date();

document.getElementById("btn-combined").addEventListener("click",()=>{showScreen("combined-screen");closeAllPanels();});
document.getElementById("cs-back-btn").addEventListener("click",()=>{showScreen("calendar-screen");isCalOpen=true;resetIdleBar();});
document.getElementById("cs-manage-btn").addEventListener("click",()=>{buildCombinedManagePanel();showP("combined-manage-panel");});
document.getElementById("cs-add-event-btn").addEventListener("click",()=>{openAddPanel(todayStr(),true);});

// Drawer toggle
document.getElementById("cs-drawer-handle").addEventListener("click",()=>{
  document.getElementById("cs-drawer").classList.toggle("open");
});

// Month nav
document.getElementById("cs-btn-prev").addEventListener("click",()=>{csViewDate.setDate(1);csViewDate.setMonth(csViewDate.getMonth()-1);renderCombinedCalendar();burst(document.getElementById("cs-btn-prev"));});
document.getElementById("cs-btn-next").addEventListener("click",()=>{csViewDate.setDate(1);csViewDate.setMonth(csViewDate.getMonth()+1);renderCombinedCalendar();burst(document.getElementById("cs-btn-next"));});

// Name edit buttons (both in identity strip and drawer)
function openNameEdit(){
  document.getElementById("name-edit-input").value=userName||"";
  showP("name-edit-panel");
}
document.getElementById("cs-name-edit-btn").addEventListener("click",openNameEdit);
document.getElementById("cs-name-edit-btn2").addEventListener("click",openNameEdit);
document.getElementById("close-name-edit").addEventListener("click",()=>closeP("name-edit-panel"));
document.getElementById("btn-save-name-edit").addEventListener("click",()=>{
  const name=document.getElementById("name-edit-input").value.trim();
  userName=name;safeSave("cal-username",userName);updateUserUI();
  closeP("name-edit-panel");toast("Name updated to \""+name+"\" ‚ú¶");
  if(curScreen==="combined-screen")renderCombinedCalendar();
});

// Join from drawer join row
document.getElementById("cs-join-btn").addEventListener("click",()=>{
  const raw=document.getElementById("cs-join-input").value.trim();
  const code=extractCode(raw);
  if(!code){toast("Enter a code ‚ú¶");return;}
  const name=attemptJoin(code);
  if(name){document.getElementById("cs-join-input").value="";renderCombinedCalendar();renderCombinedCards();toast("Joined \""+name+"\" ‚ú¶");burst(document.getElementById("cs-join-btn"));}
  else toast("Code not found ‚ú¶");
});
// Join from manage panel
document.getElementById("manage-join-btn").addEventListener("click",()=>{
  const raw=document.getElementById("manage-join-input").value.trim();
  const code=extractCode(raw);
  if(!code){toast("Enter a code ‚ú¶");return;}
  const name=attemptJoin(code);
  if(name){document.getElementById("manage-join-input").value="";buildCombinedManagePanel();renderCombinedCalendar();renderCombinedCards();toast("Joined \""+name+"\" ‚ú¶");burst(document.getElementById("manage-join-btn"));}
  else toast("Code not found ‚ú¶");
});

// New combined calendar
document.getElementById("cs-new-cal-btn").addEventListener("click",()=>{
  document.getElementById("nc-name").value="";ncColor=PALETTE[2];
  document.getElementById("nc-color-row").querySelectorAll(".c-swatch").forEach((s,i)=>s.classList.toggle("sel",i===0));
  showP("new-combined-panel");
});
document.getElementById("close-new-combined").addEventListener("click",()=>closeP("new-combined-panel"));
document.getElementById("btn-create-combined").addEventListener("click",()=>{
  const name=document.getElementById("nc-name").value.trim();
  if(!name){toast("Enter a calendar name ‚ú¶");return;}
  const code=genInviteCode(name);
  const myName=userName||"You";
  const newCal={id:"cal_"+Date.now(),name,type:"combined",color:ncColor,visible:true,inviteCode:code,members:[myName]};
  calendars.push(newCal);safeSave("cal-calendars",calendars);
  closeP("new-combined-panel");renderCombinedCalendar();renderCombinedCards();
  toast("\""+name+"\" created ‚ú¶");burst(document.getElementById("btn-create-combined"));
});

// Combined manage panel close
document.getElementById("close-combined-manage").addEventListener("click",()=>closeP("combined-manage-panel"));

// Combined day panel close
document.getElementById("cs-dp-close").addEventListener("click",()=>{
  document.getElementById("cs-day-panel").classList.remove("show");
  document.getElementById("cs-day-panel-overlay").classList.remove("show");
});
document.getElementById("cs-day-panel-overlay").addEventListener("click",()=>{
  document.getElementById("cs-day-panel").classList.remove("show");
  document.getElementById("cs-day-panel-overlay").classList.remove("show");
});

/* Extract invite code from a raw string ‚Äî handles full URLs like ?join=XXXX or bare codes */
function extractCode(raw){
  if(!raw)return null;
  // Try URL param
  try{const u=new URL(raw);const p=u.searchParams.get("join");if(p)return p.toUpperCase();}catch{}
  // Bare code pattern: letters+dash+alphanum
  const m=raw.match(/[A-Z]{2,6}-[A-Z0-9]{4,8}/i);
  if(m)return m[0].toUpperCase();
  return raw.toUpperCase().trim();
}

function attemptJoin(code){
  const existing=calendars.find(c=>c.inviteCode===code);
  if(existing){
    const myName=userName||"You";
    if(!existing.members)existing.members=[];
    if(!existing.members.includes(myName))existing.members.push(myName);
    safeSave("cal-calendars",calendars);return existing.name;
  }
  return null;
}

function genInviteCode(name){
  return name.replace(/\s+/g,"").toUpperCase().substring(0,4)+"-"+Math.random().toString(36).substring(2,6).toUpperCase();
}

/* Render combined calendar month grid ‚Äî shows all combined calendar events */
function renderCombinedCalendar(){
  updateUserUI();
  const td=THEMES.find(t=>t.id===theme)||THEMES[0];
  const mo=csViewDate.getMonth(),yr=csViewDate.getFullYear();
  document.getElementById("cs-month-label").textContent=MN[mo];
  document.getElementById("cs-year-label").textContent=yr;

  // Combined calendar title ‚Äî show which calendars
  const cals=calendars.filter(c=>c.type==="combined");
  if(cals.length===0){
    document.getElementById("cs-cal-title").textContent="Combined ‚ú¶";
    document.getElementById("cs-cal-subtitle").textContent="No shared calendars yet";
  } else if(cals.length===1){
    document.getElementById("cs-cal-title").textContent=cals[0].name+" ‚ú¶";
    document.getElementById("cs-cal-subtitle").textContent=cals[0].members?.join(", ")||"Shared";
  } else {
    document.getElementById("cs-cal-title").textContent="Combined ‚ú¶";
    document.getElementById("cs-cal-subtitle").textContent=cals.length+" shared calendars";
  }

  const combinedIds=cals.map(c=>c.id);
  const container=document.getElementById("cs-cal-days");container.innerHTML="";
  const firstWD=new Date(yr,mo,1).getDay(),dim=new Date(yr,mo+1,0).getDate(),dimPrev=new Date(yr,mo,0).getDate(),today=new Date();
  const total=Math.ceil((firstWD+dim)/7)*7;

  for(let i=0;i<total;i++){
    let day,cur=true,cMo=mo,cYr=yr;
    if(i<firstWD){day=dimPrev-firstWD+i+1;cur=false;cMo=mo-1;if(cMo<0){cMo=11;cYr=yr-1;}}
    else if(i>=firstWD+dim){day=i-firstWD-dim+1;cur=false;cMo=mo+1;if(cMo>11){cMo=0;cYr=yr+1;}}
    else day=i-firstWD+1;
    const ds=cYr+"-"+String(cMo+1).padStart(2,"0")+"-"+String(day).padStart(2,"0");
    const isToday=cur&&day===today.getDate()&&mo===today.getMonth()&&yr===today.getFullYear();
    const dayEvs=events.filter(e=>e.date===ds&&combinedIds.includes(e.calId));
    const dayHols=cur?getHolsForDate(cYr,cMo,day):[];
    const dayMood=moods[ds];

    const cell=document.createElement("div");
    cell.className="cal-day"+(isToday?" today":"")+(!cur?" other-month":"");
    cell.dataset.date=ds;

    const num=document.createElement("div");num.className="d-num";num.textContent=day;cell.appendChild(num);
    if(dayMood!=null&&MOODS[dayMood]){const md=document.createElement("div");md.className="d-mood";md.textContent=MOODS[dayMood].e;cell.appendChild(md);}
    if(dayHols.length&&cur){const hb=document.createElement("div");hb.className="d-holiday-badge";hb.textContent=dayHols[0][3];hb.title=dayHols[0][2];cell.appendChild(hb);}

    if(dayEvs.length>0){
      const dots=document.createElement("div");dots.className="d-dots";
      dayEvs.forEach(ev=>{
        const cal=calendars.find(c=>c.id===ev.calId);
        const col=ev.color||(cal?cal.color:"var(--accent)");
        const d=document.createElement("div");d.className="d-dot";d.style.background=col;
        d.title=(ev.nameLabel?ev.nameLabel+": ":"")+ev.title;
        dots.appendChild(d);
      });
      cell.appendChild(dots);

      const labels=document.createElement("div");labels.className="d-labels";
      dayEvs.slice(0,2).forEach(ev=>{
        const cal=calendars.find(c=>c.id===ev.calId);
        const col=ev.color||(cal?cal.color:"var(--accent)");
        const chip=document.createElement("div");chip.className="ev-chip combined-tag";chip.style.background=col;
        chip.textContent=(ev.nameLabel?"["+ev.nameLabel+"] ":"")+ev.title;
        labels.appendChild(chip);
      });
      if(dayEvs.length>2){const more=document.createElement("div");more.className="ev-more";more.textContent="+"+(dayEvs.length-2)+" more";labels.appendChild(more);}
      cell.appendChild(labels);
    }

    // Click opens the combined day panel
    cell.addEventListener("click",()=>{
      if(cur)openCombinedDayPanel(ds);
    });
    container.appendChild(cell);
  }

  // Also refresh the cards in the drawer
  renderCombinedCards();
}

function openCombinedDayPanel(ds){
  const d=new Date(ds+"T12:00:00");
  document.getElementById("cs-dp-date-title").textContent=MN[d.getMonth()]+" "+d.getDate()+", "+d.getFullYear();
  const combinedIds=calendars.filter(c=>c.type==="combined").map(c=>c.id);
  const dayEvs=events.filter(e=>e.date===ds&&combinedIds.includes(e.calId)).sort((a,b)=>(a.time||"99:99").localeCompare(b.time||"99:99"));
  const list=document.getElementById("cs-dp-ev-list");list.innerHTML="";
  const myName=userName||"";
  if(!dayEvs.length){
    list.innerHTML='<div class="cs-no-events" style="margin:10px 0">No events on this day ‚ú¶</div>';
  } else {
    dayEvs.forEach(ev=>{
      const cal=calendars.find(c=>c.id===ev.calId);
      const col=ev.color||(cal?cal.color:"var(--accent)");
      const isYouEv=ev.nameLabel&&ev.nameLabel===myName;
      const item=document.createElement("div");item.className="cs-ev-item";
      item.innerHTML=`<div class="cs-ev-dot" style="background:${col}"></div>
        <div class="cs-ev-info">
          <div class="cs-ev-title">${esc(ev.title)}</div>
          <div class="cs-ev-meta">${ev.time?fmtTime(ev.time)+" ¬∑ ":""}${esc(cal?.name||"Combined")}</div>
        </div>
        ${ev.nameLabel?`<span class="cs-ev-name-badge${isYouEv?" is-you":""}">${esc(ev.nameLabel)}</span>`:""}
        <button class="cs-ev-del">‚úï</button>`;
      item.querySelector(".cs-ev-del").addEventListener("click",e=>{e.stopPropagation();deleteEvent(ev.id);openCombinedDayPanel(ds);renderCombinedCalendar();});
      list.appendChild(item);
    });
  }
  document.getElementById("cs-dp-add-btn").onclick=()=>{
    document.getElementById("cs-day-panel").classList.remove("show");
    document.getElementById("cs-day-panel-overlay").classList.remove("show");
    openAddPanel(ds,true);
  };
  document.getElementById("cs-day-panel").classList.add("show");
  document.getElementById("cs-day-panel-overlay").classList.add("show");
}

/* Calendar cards in the drawer */
function renderCombinedCards(){
  const wrap=document.getElementById("cs-cals-wrap");wrap.innerHTML="";
  const cals=calendars.filter(c=>c.type==="combined");
  const myName=userName||"";
  if(!cals.length){
    const empty=document.createElement("div");
    empty.style.cssText="text-align:center;padding:20px;font-family:var(--font-accent);font-size:1rem;color:var(--accent);opacity:.35";
    empty.textContent="No shared calendars yet ‚ú¶";
    wrap.appendChild(empty);return;
  }
  cals.forEach(cal=>{
    if(!cal.members)cal.members=[];
    if(myName&&!cal.members.includes(myName)){cal.members.push(myName);safeSave("cal-calendars",calendars);}
    const calEvs=events.filter(e=>e.calId===cal.id).sort((a,b)=>a.date.localeCompare(b.date)).slice(0,4);

    const card=document.createElement("div");card.className="cs-cal-card";
    // Header
    const hdr=document.createElement("div");hdr.className="cs-cal-card-header";
    hdr.innerHTML=`<div class="cs-cal-dot" style="background:${cal.color}"></div><div class="cs-cal-name">${esc(cal.name)}</div><span class="cs-cal-badge">üîó Combined</span>`;
    card.appendChild(hdr);
    // Body
    const body=document.createElement("div");body.className="cs-cal-body";
    // Invite
    const inv=document.createElement("div");inv.className="cs-invite-section";
    inv.innerHTML=`<div class="cs-invite-label">Share Invite ‚Äî link goes straight to this calendar</div>
      <div class="cs-invite-row">
        <div class="cs-code">${cal.inviteCode}</div>
        <button class="cs-action-btn" onclick="copyInviteCode('${cal.id}')">Copy Code</button>
        <button class="cs-action-btn outline" onclick="shareInviteLink('${cal.id}')">Share Link ‚Üó</button>
      </div>`;
    body.appendChild(inv);
    // Members
    const memSec=document.createElement("div");memSec.className="cs-members-section";
    const memLbl=document.createElement("div");memLbl.className="cs-members-label";memLbl.textContent=`Members (${cal.members.length})`;
    memSec.appendChild(memLbl);
    const memList=document.createElement("div");memList.className="cs-members-list";
    cal.members.forEach((m,idx)=>{
      const isYou=m===myName||(idx===0&&!myName);
      const chip=document.createElement("span");chip.className="cs-member-chip"+(isYou?" is-you":"");
      const av=document.createElement("div");av.className="cs-member-avatar";av.textContent=m.charAt(0).toUpperCase()||"?";av.style.background=cal.color;
      chip.appendChild(av);chip.appendChild(document.createTextNode(m+(isYou?" (you)":"")));
      if(!isYou){
        const del=document.createElement("button");del.className="cs-member-del";del.textContent="‚úï";del.title="Remove";
        del.addEventListener("click",e=>{e.stopPropagation();cal.members.splice(idx,1);safeSave("cal-calendars",calendars);renderCombinedCards();});
        chip.appendChild(del);
      }
      memList.appendChild(chip);
    });
    memSec.appendChild(memList);body.appendChild(memSec);
    // Recent events
    const evSec=document.createElement("div");evSec.className="cs-events-section";
    const evLbl=document.createElement("div");evLbl.className="cs-events-label";
    evLbl.textContent="Recent Events ("+events.filter(e=>e.calId===cal.id).length+")";
    evSec.appendChild(evLbl);
    const evList=document.createElement("div");evList.className="cs-ev-list";
    if(!calEvs.length){evList.innerHTML='<div class="cs-no-events">No events yet ‚ú¶</div>';}
    else calEvs.forEach(ev=>{
      const isYouEv=ev.nameLabel&&ev.nameLabel===myName;
      const d=new Date(ev.date+"T12:00:00");
      const item=document.createElement("div");item.className="cs-ev-item";
      item.innerHTML=`<div class="cs-ev-dot" style="background:${ev.color||cal.color}"></div>
        <div class="cs-ev-info"><div class="cs-ev-title">${esc(ev.title)}</div>
        <div class="cs-ev-meta">${MN[d.getMonth()].substring(0,3)} ${d.getDate()}${ev.time?" ¬∑ "+fmtTime(ev.time):""}</div></div>
        ${ev.nameLabel?`<span class="cs-ev-name-badge${isYouEv?" is-you":""}">${esc(ev.nameLabel)}</span>`:""}
        <button class="cs-ev-del">‚úï</button>`;
      item.querySelector(".cs-ev-del").addEventListener("click",e=>{e.stopPropagation();deleteEvent(ev.id);renderCombinedCalendar();renderCombinedCards();});
      evList.appendChild(item);
    });
    evSec.appendChild(evList);
    const addBtn=document.createElement("button");addBtn.className="cs-add-event-btn";addBtn.textContent="+ Add Event to "+cal.name;
    addBtn.addEventListener("click",()=>{openAddPanel(todayStr(),true);setTimeout(()=>{document.getElementById("ev-cal-select").value=cal.id;updateCalSelectUI();},50);});
    evSec.appendChild(addBtn);
    body.appendChild(evSec);
    // Delete
    const delRow=document.createElement("div");delRow.style.cssText="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,.08);display:flex;justify-content:flex-end";
    const delBtn=document.createElement("button");delBtn.className="cs-action-btn danger";delBtn.textContent="Delete Calendar";
    delBtn.addEventListener("click",()=>{
      if(!confirm("Delete \""+cal.name+"\" and all its events?"))return;
      calendars=calendars.filter(c=>c.id!==cal.id);events=events.filter(e=>e.calId!==cal.id);
      safeSave("cal-calendars",calendars);safeSave("cal-events",events);
      renderCombinedCalendar();renderCalendar();renderIdleEvents();toast("Deleted ‚ú¶");
    });
    delRow.appendChild(delBtn);body.appendChild(delRow);
    card.appendChild(body);wrap.appendChild(card);
  });
}

/* Manage panel (full list with share) */
function buildCombinedManagePanel(){
  const container=document.getElementById("combined-manage-list");container.innerHTML="";
  const cals=calendars.filter(c=>c.type==="combined");
  if(!cals.length){
    container.innerHTML='<div style="text-align:center;padding:20px;font-family:var(--font-body);font-size:.76rem;opacity:.35;font-style:italic">No combined calendars yet.<br>Create one from the Combined screen.</div>';return;
  }
  cals.forEach(cal=>{
    const card=document.createElement("div");card.className="cs-cal-card";card.style.marginBottom="10px";
    card.innerHTML=`<div class="cs-cal-card-header"><div class="cs-cal-dot" style="background:${cal.color}"></div><div class="cs-cal-name">${esc(cal.name)}</div></div>
      <div class="cs-cal-body">
        <div class="cs-invite-section">
          <div class="cs-invite-label">Invite Link ‚Äî sharing opens this calendar on the recipient's device</div>
          <div class="cs-invite-row">
            <div class="cs-code">${cal.inviteCode}</div>
            <button class="cs-action-btn" onclick="copyInviteCode('${cal.id}')">Copy</button>
            <button class="cs-action-btn outline" onclick="shareInviteLink('${cal.id}')">Share ‚Üó</button>
          </div>
        </div>
        <div style="font-family:var(--font-body);font-size:.56rem;letter-spacing:.12em;text-transform:uppercase;color:var(--accent);opacity:.55;margin-bottom:4px">Members: ${esc(cal.members?.join(", ")||"None")}</div>
      </div>`;
    container.appendChild(card);
  });
}

/* Share invite link ‚Äî sends URL with ?join=CODE so recipient lands on site and auto-joins */
function shareInviteLink(calId){
  const cal=calendars.find(c=>c.id===calId);if(!cal)return;
  const baseUrl=location.href.split("?")[0];
  const shareUrl=baseUrl+"?join="+cal.inviteCode;
  const by=userName?`${userName} invited you to`:`Join`;
  const shareText=`${by} "${cal.name}" on Aesthetic Calendar ‚ú¶\n\nTap the link to join automatically with your invite code included.`;
  if(navigator.share){
    navigator.share({title:`Join "${cal.name}" ‚ú¶`,text:shareText,url:shareUrl})
      .then(()=>toast("Link shared ‚ú¶"))
      .catch(()=>copyToClipboard(shareUrl,"Link copied ‚ú¶"));
  } else {
    copyToClipboard(shareUrl,"Link copied ‚Äî paste to share ‚ú¶");
  }
}
function copyInviteCode(calId){
  const cal=calendars.find(c=>c.id===calId);if(!cal)return;
  copyToClipboard(cal.inviteCode,"Code copied: "+cal.inviteCode+" ‚ú¶");
}
function copyToClipboard(text,msg){
  if(navigator.clipboard)navigator.clipboard.writeText(text).then(()=>toast(msg)).catch(()=>toast(text));
  else toast(text);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NOTES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.getElementById("btn-notes").addEventListener("click",()=>{document.getElementById("note-text").value="";document.getElementById("note-date").value=todayStr();renderNotes();showP("notes-panel");});
document.getElementById("close-notes").addEventListener("click",()=>closeP("notes-panel"));
document.getElementById("btn-save-note").addEventListener("click",()=>{
  const txt=document.getElementById("note-text").value.trim();
  if(!txt){toast("Write something ‚ú¶");return;}
  notes.push({id:Date.now(),text:txt,date:document.getElementById("note-date").value||todayStr()});
  safeSave("cal-notes",notes);document.getElementById("note-text").value="";renderNotes();toast("Note saved ‚ú¶");
});
function renderNotes(){
  const list=document.getElementById("notes-list");
  if(!notes.length){list.innerHTML='<p style="text-align:center;opacity:.35;font-size:.74rem;padding:12px;font-family:var(--font-body)">No notes yet ‚ú¶</p>';return;}
  list.innerHTML="";
  [...notes].reverse().forEach(n=>{
    const item=document.createElement("div");item.className="note-item";
    item.innerHTML="<div class=\"note-tag\">"+n.date+"</div><div>"+esc(n.text)+"</div><button class=\"note-del\" data-id=\""+n.id+"\">‚úï</button>";
    list.appendChild(item);
  });
  list.querySelectorAll(".note-del").forEach(btn=>btn.addEventListener("click",()=>{notes=notes.filter(n=>n.id!==Number(btn.dataset.id));safeSave("cal-notes",notes);renderNotes();}));
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   THEME PANEL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.getElementById("btn-theme").addEventListener("click",()=>showP("theme-panel"));
document.getElementById("close-theme").addEventListener("click",()=>closeP("theme-panel"));
function buildThemeGrid(){
  const grid=document.getElementById("theme-grid");grid.innerHTML="";
  THEMES.forEach(td=>{
    const card=document.createElement("div");card.className="t-card"+(td.id===theme?" active":"");card.dataset.id=td.id;
    card.innerHTML=`<div class="t-card-preview" style="${td.bg};border-radius:12px;position:absolute;inset:0"></div><div class="t-card-content" style="position:relative;z-index:1"><div class="t-emoji">${td.emoji}</div><div class="t-name">${td.name}</div><div class="t-desc">${td.desc}</div></div>`;
    card.addEventListener("click",()=>{applyTheme(td.id);closeP("theme-panel");toast("Theme: "+td.name+" ‚ú¶");burst(card);});
    grid.appendChild(card);
  });
}
buildThemeGrid();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HOLIDAYS PANEL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.getElementById("btn-holidays").addEventListener("click",()=>{buildHolidayList();showP("holiday-panel");});
document.getElementById("close-holiday").addEventListener("click",()=>closeP("holiday-panel"));
function buildHolidayList(){
  const container=document.getElementById("holiday-list");container.innerHTML="";
  const yr=viewDate.getFullYear();const all=getAllHols(yr);let curMo=-1;let sec;
  all.forEach(h=>{
    if(h[0]!==curMo){curMo=h[0];sec=document.createElement("div");sec.className="holiday-month";sec.innerHTML="<div class=\"holiday-month-name\">"+MN[h[0]-1]+"</div>";container.appendChild(sec);}
    const item=document.createElement("div");item.className="holiday-item";
    const ds=new Date(yr,h[0]-1,h[1]).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});
    item.innerHTML=`<div class="holiday-icon">${h[3]}</div><div class="holiday-info"><div class="holiday-name">${esc(h[2])}</div><div class="holiday-date-text">${ds}</div></div>`;
    sec.appendChild(item);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MANAGE CALENDARS (personal only)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.getElementById("btn-manage-cals").addEventListener("click",()=>{renderCalList();showP("manage-cals-panel");});
document.getElementById("close-manage-cals").addEventListener("click",()=>closeP("manage-cals-panel"));
function renderCalList(){
  const container=document.getElementById("cal-list");container.innerHTML="";
  const personal=calendars.filter(c=>c.type==="personal");
  const sec=document.createElement("div");sec.className="cal-list-section";
  sec.innerHTML='<div class="cal-list-section-title"><span>üë§</span>Personal Calendars</div>';
  personal.forEach(cal=>{
    const canDel=cal.id!=="personal";
    const item=document.createElement("div");item.className="cal-item";
    item.innerHTML=`<div class="cal-item-dot" style="background:${cal.color}"></div><div class="cal-item-name">${esc(cal.name)}</div><span class="cal-item-type type-personal">üë§ Personal</span><button class="cal-toggle${cal.visible?"":" off"}" data-id="${cal.id}"></button>${canDel?`<button class="cal-item-del" data-id="${cal.id}">‚úï</button>`:""}`;
    sec.appendChild(item);
  });
  container.appendChild(sec);
  container.querySelectorAll(".cal-toggle").forEach(btn=>btn.addEventListener("click",()=>{const cal=calendars.find(c=>c.id===btn.dataset.id);if(cal){cal.visible=!cal.visible;btn.classList.toggle("off",!cal.visible);safeSave("cal-calendars",calendars);renderCalendar();renderCalSections();renderIdleEvents();}}));
  container.querySelectorAll(".cal-item-del").forEach(btn=>btn.addEventListener("click",()=>{if(!confirm("Delete calendar and all its events?"))return;calendars=calendars.filter(c=>c.id!==btn.dataset.id);events=events.filter(e=>e.calId!==btn.dataset.id);safeSave("cal-calendars",calendars);safeSave("cal-events",events);if(activeCalId===btn.dataset.id)activeCalId="all";renderCalList();renderCalSections();renderCalendar();renderIdleEvents();toast("Deleted ‚ú¶");}));
}
document.querySelectorAll(".cal-type-btn").forEach(btn=>btn.addEventListener("click",()=>{document.querySelectorAll(".cal-type-btn").forEach(b=>b.classList.remove("selected"));btn.classList.add("selected");selCalType=btn.dataset.type;}));
document.getElementById("btn-save-cal").addEventListener("click",()=>{
  const name=document.getElementById("new-cal-name").value.trim();
  if(!name){toast("Please enter a name ‚ú¶");return;}
  const nc={id:"cal_"+Date.now(),name,type:"personal",color:selCalColor,visible:true};
  calendars.push(nc);safeSave("cal-calendars",calendars);
  document.getElementById("new-cal-name").value="";
  renderCalList();renderCalSections();toast("\""+name+"\" created ‚ú¶");burst(document.getElementById("btn-save-cal"));
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NAV
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.getElementById("btn-prev").addEventListener("click",()=>{viewDate.setDate(1);viewDate.setMonth(viewDate.getMonth()-1);renderCalendar();burst(document.getElementById("btn-prev"));});
document.getElementById("btn-next").addEventListener("click",()=>{viewDate.setDate(1);viewDate.setMonth(viewDate.getMonth()+1);renderCalendar();burst(document.getElementById("btn-next"));});
document.getElementById("btn-today").addEventListener("click",()=>{viewDate=new Date();renderCalendar();toast("Back to today ‚ú¶");});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PANEL HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const ALL_PANELS=["add-event-panel","notes-panel","theme-panel","manage-cals-panel","holiday-panel","mood-popup","name-edit-panel","new-combined-panel","day-panel","combined-manage-panel"];
function showP(id){
  closeAllPanels();curPanel=id;
  const el=document.getElementById(id);
  if(!el)return;el.classList.add("show");document.getElementById("overlay").classList.add("show");
}
function closeP(id){
  const el=document.getElementById(id);
  if(el)el.classList.remove("show");document.getElementById("overlay").classList.remove("show");curPanel=null;
}
function closeAllPanels(){
  ALL_PANELS.forEach(id=>document.getElementById(id)?.classList.remove("show"));
  document.getElementById("overlay").classList.remove("show");curPanel=null;
}
document.getElementById("overlay").addEventListener("click",closeAllPanels);
document.addEventListener("keydown",e=>{
  if(curScreen==="name-setup-screen")return;
  onActivity();
  if(e.key==="Escape"){if(curPanel)closeAllPanels();else if(curScreen==="combined-screen")showScreen("calendar-screen");}
  if(!curPanel&&curScreen==="calendar-screen"){
    if(e.key==="ArrowLeft")document.getElementById("btn-prev").click();
    if(e.key==="ArrowRight")document.getElementById("btn-next").click();
    if(e.key==="n"||e.key==="N")openAddPanel(todayStr(),false);
  }
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COLOR ROWS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildColorRow(rowId,cb){
  const row=document.getElementById(rowId);if(!row)return;row.innerHTML="";
  PALETTE.forEach((c,i)=>{
    const sw=document.createElement("div");sw.className="c-swatch"+(i===0?" sel":"");sw.style.background=c;
    sw.addEventListener("click",()=>{row.querySelectorAll(".c-swatch").forEach(s=>s.classList.remove("sel"));sw.classList.add("sel");cb(c);});
    row.appendChild(sw);
  });
}
buildColorRow("color-row",c=>selColor=c);
buildColorRow("cal-color-row",c=>selCalColor=c);
buildColorRow("nc-color-row",c=>ncColor=c);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PARTICLES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(function(){
  const canvas=document.getElementById("particle-canvas"),ctx=canvas.getContext("2d");
  function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}resize();
  window.addEventListener("resize",resize);
  const P=Array.from({length:26},()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,r:.5+Math.random()*1.7,vx:(Math.random()-.5)*.26,vy:-.07-Math.random()*.26,a:.16+Math.random()*.35}));
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const acc=getComputedStyle(document.documentElement).getPropertyValue("--accent").trim()||"#4a8fa8";
    P.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.y<-6){p.y=canvas.height+6;p.x=Math.random()*canvas.width;}if(p.x<-6)p.x=canvas.width+6;if(p.x>canvas.width+6)p.x=-6;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fillStyle=acc;ctx.globalAlpha=p.a;ctx.fill();});
    ctx.globalAlpha=1;requestAnimationFrame(draw);
  }draw();
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BURST & TOAST
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function burst(el){
  const r=el?el.getBoundingClientRect():{left:innerWidth/2-20,top:innerHeight/2,width:40,height:0};
  const cols=["#f060a8","#4a8fa8","#a8c060","#c8a060","#9040c0","#c8820a","#c84040","#e8a040"];
  for(let i=0;i<16;i++){const p=document.createElement("div");p.className="piece";const sz=4+Math.random()*7;p.style.cssText="left:"+(r.left+r.width/2+(Math.random()-.5)*52)+"px;top:"+r.top+"px;width:"+sz+"px;height:"+sz+"px;background:"+cols[i%cols.length]+";border-radius:"+(Math.random()>.5?"50%":"2px")+";animation-delay:"+(Math.random()*.24)+"s;transform:translateX("+(Math.random()-.5)*76+"px)";document.body.appendChild(p);setTimeout(()=>p.remove(),1600);}
}
const toastEl=document.getElementById("toast");let toastTm;
function toast(msg){toastEl.textContent=msg;toastEl.classList.add("show");clearTimeout(toastTm);toastTm=setTimeout(()=>toastEl.classList.remove("show"),2500);}
function todayStr(){const d=new Date();return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");}
function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
applyTheme(theme);
initNameSetup();
(function scheduleNext(){
  const now=new Date(),next=new Date(now.getFullYear(),now.getMonth()+1,1);
  setTimeout(()=>{if(viewDate.getMonth()===now.getMonth()&&viewDate.getFullYear()===now.getFullYear()){viewDate=new Date();renderCalendar();toast("Welcome to "+MN[viewDate.getMonth()]+" ‚ú¶");}scheduleNext();},next-now);
})();
</script>
</body>
</html>